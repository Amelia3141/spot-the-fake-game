<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot The Fake</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e8f5e9 100%); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 32px; margin-bottom: 5px; }
        h2 { font-size: 24px; margin-bottom: 15px; }
        .subtitle { color: #666; font-size: 14px; }
        .score { text-align: right; }
        .score-label { font-size: 12px; color: #999; }
        .score-value { font-size: 36px; font-weight: bold; }
        .card { background: white; border: 2px solid #4caf50; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .round-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .round-title { font-size: 20px; font-weight: bold; }
        .round-number { background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
        .instructions { color: #666; margin-bottom: 20px; font-size: 14px; }
        .facts { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .fact { padding: 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: left; background: white; }
        .fact:hover:not(.disabled) { border-color: #4caf50; }
        .fact.selected { background: #e8f5e9; border-color: #4caf50; }
        .fact.correct { background: #e8f5e9; border-color: #4caf50; }
        .fact.wrong { background: #ffebee; border-color: #f44336; }
        .fact.disabled { cursor: not-allowed; }
        .fact-name { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #ff9800; }
        .fact-desc { font-size: 14px; color: #555; line-height: 1.5; }
        .fact-badge { display: inline-block; margin-top: 10px; padding: 6px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        .badge-fake { background: #f44336; }
        .badge-real { background: #4caf50; }
        .explanation { background: #f0f7e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none; }
        .explanation.show { display: block; }
        .explanation-title { font-weight: bold; margin-bottom: 8px; }
        .explanation-text { font-size: 14px; line-height: 1.6; color: #333; }
        button { background: linear-gradient(135deg, #ff9800 0%, #4caf50 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .game-over { text-align: center; }
        .final-score { font-size: 64px; font-weight: bold; color: #4caf50; margin: 20px 0; }
        .message { font-size: 18px; margin-bottom: 20px; }
        .lesson { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 13px; }
        .difficulty-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .difficulty-btn { padding: 12px; font-size: 14px; }
        .difficulty-btn.active { background: #4caf50; }
        .difficulty-btn.inactive { background: #ddd; color: #333; }
        .difficulty-btn:hover { transform: none; }
        .menu-section { margin-bottom: 30px; }
        .difficulty-desc { font-size: 12px; color: #666; margin-top: 10px; }
        .error-message { color: #f44336; font-size: 12px; margin-top: 5px; }
        input { font-family: inherit; }
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .score { margin-top: 15px; }
            h1 { font-size: 24px; }
            .difficulty-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div id="game"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUdAqlDwN_1lRlbBHaA37RPscAtuxIXTA",
            authDomain: "spot-fake-game.firebaseapp.com",
            databaseURL: "https://spot-fake-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spot-fake-game",
            storageBucket: "spot-fake-game.firebasestorage.app",
            messagingSenderId: "141455787893",
            appId: "1:141455787893:web:e94feb2716c98336f1753c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // COLOR-CODED BUTTONS
        const BUTTON_COLORS = {
            A: { bg: '#FF4757', text: 'white' },
            B: { bg: '#0066FF', text: 'white' },
            C: { bg: '#2ED573', text: 'white' },
            D: { bg: '#FFA502', text: 'white' }
        };

        // NAME VALIDATION
        const blockedWords = [
            'f4g', 'fagg', 'n1gg', 'nigg', 'sh1t', 'shitt', 
            'kys', 'kill', 'die', 'slut', 'whore', 'cunt'
        ];

        const whitelistedNames = [
            'assana', 'assane', 'shaniqua', 'gaylord', 'dick', 'dickson', 
            'fanny', 'fannie', 'shitley', 'damn', 'dammit', 'ass'
        ];

        function isNameValid(name) {
            const lower = name.toLowerCase().trim();
            
            if (lower.length < 2 || lower.length > 30) {
                return { valid: false, reason: 'Name must be 2-30 characters' };
            }
            
            for (let word of blockedWords) {
                if (lower.includes(word)) {
                    return { valid: false, reason: 'Name contains restricted content' };
                }
            }
            
            const profanityPatterns = [
                { regex: /shit/i, safe: false },
                { regex: /fuck/i, safe: false },
                { regex: /damn/i, safe: false },
                { regex: /ass(?!ana|ane)/i, safe: false },
                { regex: /dick(?!inson|son)/i, safe: false },
                { regex: /dick$/i, safe: true },
                { regex: /fanny$/i, safe: true },
                { regex: /^hell/i, safe: false },
                { regex: /bitch/i, safe: false }
            ];
            
            for (let pattern of profanityPatterns) {
                if (pattern.regex.test(lower)) {
                    const isWhitelisted = whitelistedNames.some(wl => 
                        lower === wl.toLowerCase() || lower.includes(wl.toLowerCase())
                    );
                    if (!isWhitelisted && !pattern.safe) {
                        return { valid: false, reason: 'Name contains restricted content' };
                    }
                }
            }
            
            if (/(.)\1{4,}/.test(lower)) {
                return { valid: false, reason: 'Name contains too many repeated characters' };
            }
            
            if (!/[a-z]/i.test(lower)) {
                return { valid: false, reason: 'Name must contain at least one letter' };
            }
            
            return { valid: true };
        }


        // CALL MY BLUFF - EASY MODE
// CALL MY BLUFF - EASY MODE (fakes are obviously wrong, but same formatting as real)
// CALL MY BLUFF - EASY MODE (for bright 6-7 year olds at 75%)
        // CALL MY BLUFF - EASY MODE (for bright 6-7 year olds at 75%)
        // Add this shuffle function at the top of your script section (before game state)
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// UPDATED GAME STATE - add shuffleState to track randomization
let state = {
    gameStarted: false,
    mode: null,
    difficulty: 'medium',
    round: 0,
    score: 0,
    selected: null,
    revealed: false,
    complete: false,
    playerName: null,
    leaderboard: [],
    nameError: '',
    shuffledIndices: []  // NEW: track which position is real/fake
};

// UPDATED selectFact function to handle randomized positions
function selectFact(idx) {
    if (state.revealed) return;
    state.selected = idx;
    
    if (state.mode === 'spotfake') {
        const roundsToUse = getRounds(state.difficulty, state.mode);
        const round = roundsToUse[state.round];
        const selectedFact = round.facts[idx];
        const isCorrect = selectedFact.fake;
        if (isCorrect) state.score++;
    } else {
        const roundsToUse = getRounds(state.difficulty, state.mode);
        const pair = roundsToUse[state.round].pairs[0];
        
        // For randomized pairs, check if selected index 0 matches where real is positioned
        const realIsAtZero = pair.correctIsReal === true;
        let isCorrect;
        
        if (state.shuffledIndices.length === 0) {
            // Fallback if shuffle wasn't done (shouldn't happen)
            isCorrect = (idx === 0) === pair.correctIsReal;
        } else {
            // idx 0 = position A, idx 1 = position B
            // Check if the selected position has the real definition
            if (idx === 0 && state.shuffledIndices[0] === 'real') {
                isCorrect = pair.correctIsReal;
            } else if (idx === 1 && state.shuffledIndices[1] === 'real') {
                isCorrect = pair.correctIsReal;
            } else {
                isCorrect = false;
            }
        }
        
        if (isCorrect) state.score++;
    }
    
    state.revealed = true;
    render();
}

// UPDATED nextRound function to trigger shuffle for next round
function nextRound() {
    const roundsToUse = getRounds(state.difficulty, state.mode);
    if (state.round < roundsToUse.length - 1) {
        state.round++;
        state.selected = null;
        state.revealed = false;
        state.shuffledIndices = [];  // Reset for new round
    } else {
        state.complete = true;
    }
    render();
}

// UPDATED render function - for Call My Bluff, randomize and shuffle on display
function render() {
    const gameEl = document.getElementById('game');

    if (!state.gameStarted) {
        // ... menu rendering code stays the same
    }

    // ... other renders stay the same until the Call My Bluff game render

    const roundsToUse = getRounds(state.difficulty, state.mode);
    
    if (state.mode === 'spotfake') {
        // SPOT THE FAKE - shuffle facts array each time (already randomized in content)
        const round = roundsToUse[state.round];
        const shuffledFacts = shuffleArray(round.facts);
        
        let factsHtml = '';
        shuffledFacts.forEach((fact, idx) => {
            const buttonColor = BUTTON_COLORS[['A', 'B', 'C', 'D'][idx]];
            let classes = 'fact';
            if (state.revealed) {
                if (fact.fake && state.selected === idx) classes += ' correct';
                else if (!fact.fake && state.selected === idx) classes += ' wrong';
                else if (fact.fake) classes += ' wrong';
                classes += ' disabled';
            } else {
                if (state.selected === idx) classes += ' selected';
            }
            
            let badge = '';
            if (state.revealed && fact.fake) {
                badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ AI-GENERATED FAKE</span>' : '<span class="fact-badge badge-fake">AI FAKE</span>';
            } else if (state.revealed && !fact.fake && state.selected === idx) {
                badge = '<span class="fact-badge badge-real">✓ REAL</span>';
            }
            
            const letter = String.fromCharCode(65 + idx);
            factsHtml += `
                <div class="${classes}" onclick="selectFact(${idx})" style="border-color: ${buttonColor.bg}; border-width: ${state.selected === idx ? '3px' : '2px'};">
                    <div class="fact-name" style="color: ${buttonColor.bg};"><span style="display: inline-block; min-width: 30px; font-weight: bold;">${letter}.</span> ${fact.name}</div>
                    <div class="fact-desc">${fact.desc}</div>
                    ${badge}
                </div>
            `;
        });

        let explanation = '';
        if (state.revealed) {
            explanation = `
                <div class="explanation show">
                    <div class="explanation-title">Why was it fake?</div>
                    <div class="explanation-text">${round.explain}</div>
                </div>
            `;
        }

        gameEl.innerHTML = `
            <div class="header">
                <div>
                    <h1>Spot The Fake</h1>
                    <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                </div>
                <div class="score">
                    <div class="score-label">Score</div>
                    <div class="score-value">${state.score}/4</div>
                </div>
            </div>
            <div class="card">
                <div class="round-info">
                    <div class="round-title">${round.title}</div>
                    <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                </div>
                <div class="instructions">3 of these are REAL medical conditions. 1 is completely made up by AI. Which one is fake?</div>
                <div class="instructions" style="font-size: 12px; color: #999;">Press A, B, C, or D on your keyboard to select</div>
                <div class="facts">
                    ${factsHtml}
                </div>
                ${explanation}
                ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
            </div>
            <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
            <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
        `;
    } else {
        // CALL MY BLUFF - randomize A/B positions each time
        const round = roundsToUse[state.round];
        const pair = round.pairs[0];
        
        // Shuffle the pair positions on first reveal of this round
        if (state.shuffledIndices.length === 0) {
            const indices = [0, 1];
            state.shuffledIndices = shuffleArray(indices).map(i => i === 0 ? 'real' : 'fake');
        }
        
        // Get definitions in shuffled order
        const definitions = [pair.real, pair.fake];
        const shuffledDefs = [
            state.shuffledIndices[0] === 'real' ? pair.real : pair.fake,
            state.shuffledIndices[1] === 'real' ? pair.real : pair.fake
        ];
        
        let factsHtml = `
            <div style="margin-bottom: 20px;">
                <div style="background: #f0f7e8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #4caf50;">${pair.condition}</div>
                    <div style="font-size: 14px; color: #666;">Which definition is correct?</div>
                </div>
            </div>
        `;

        [shuffledDefs[0], shuffledDefs[1]].forEach((definition, idx) => {
            const buttonColor = BUTTON_COLORS[['A', 'B'][idx]];
            const isCorrectAtThisPosition = (idx === 0 && state.shuffledIndices[0] === 'real') || 
                                            (idx === 1 && state.shuffledIndices[1] === 'real');
            let classes = 'fact';
            
            if (state.revealed) {
                if (isCorrectAtThisPosition && state.selected === idx) classes += ' correct';
                else if (!isCorrectAtThisPosition && state.selected === idx) classes += ' wrong';
                else if (isCorrectAtThisPosition) classes += ' wrong';
                classes += ' disabled';
            } else {
                if (state.selected === idx) classes += ' selected';
            }
            
            let badge = '';
            if (state.revealed && !isCorrectAtThisPosition) {
                badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ WRONG</span>' : '<span class="fact-badge badge-fake">FAKE</span>';
            } else if (state.revealed && isCorrectAtThisPosition && state.selected === idx) {
                badge = '<span class="fact-badge badge-real">✓ CORRECT</span>';
            }
            
            const letter = String.fromCharCode(65 + idx);
            factsHtml += `
                <div class="${classes}" onclick="selectFact(${idx})" style="border-color: ${buttonColor.bg}; border-width: ${state.selected === idx ? '3px' : '2px'};">
                    <div class="fact-name" style="color: ${buttonColor.bg};">${letter}. ${idx === 0 ? 'Definition A' : 'Definition B'}</div>
                    <div class="fact-desc">${definition}</div>
                    ${badge}
                </div>
            `;
        });
        });

        let explanation = '';
        if (state.revealed) {
            explanation = `
                <div class="explanation show">
                    <div class="explanation-title">Why?</div>
                    <div class="explanation-text">${round.explain}</div>
                </div>
            `;
        }

        gameEl.innerHTML = `
            <div class="header">
                <div>
                    <h1>Call My Bluff</h1>
                    <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                </div>
                <div class="score">
                    <div class="score-label">Score</div>
                    <div class="score-value">${state.score}/4</div>
                </div>
            </div>
            <div class="card">
                <div class="round-info">
                    <div class="round-title">${round.title}</div>
                    <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                </div>
                <div class="instructions">Pick the correct definition.</div>
                <div class="instructions" style="font-size: 12px; color: #999;">Press A or B on your keyboard to select</div>
                <div class="facts">
                    ${factsHtml}
                </div>
                ${explanation}
                ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
            </div>
            <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
            <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
        `;
    }
}

        function getRounds(difficulty, mode) {
            if (mode === 'spotfake') {
                if (difficulty === 'easy') return spotFakeRoundsEasy;
                if (difficulty === 'hard') return spotFakeRoundsHard;
                return spotFakeRoundsMedium;
            }
            if (difficulty === 'easy') return roundsEasy;
            if (difficulty === 'hard') return roundsHard;
            return roundsMedium;
        }

        function getNumOptions(mode) {
            return mode === 'spotfake' ? 4 : 2;
        }

        function setDifficulty(level) {
            state.difficulty = level;
            render();
        }

        function startGame(mode) {
            state.gameStarted = true;
            state.mode = mode;
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            render();
        }

        function backToMenu() {
            state.gameStarted = false;
            state.complete = false;
            state.playerName = null;
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            state.mode = null;
            state.nameError = '';
            render();
        }

        function selectFact(idx) {
            if (state.revealed) return;
            state.selected = idx;
            
            if (state.mode === 'spotfake') {
                const roundsToUse = getRounds(state.difficulty, state.mode);
                const round = roundsToUse[state.round];
                const isCorrect = round.facts[idx].fake;
                if (isCorrect) state.score++;
            } else {
                const roundsToUse = getRounds(state.difficulty, state.mode);
                const pair = roundsToUse[state.round].pairs[0];
                const isCorrect = (idx === 0) === pair.correctIsReal;
                if (isCorrect) state.score++;
            }
            
            state.revealed = true;
            render();
        }

        function nextRound() {
            const roundsToUse = getRounds(state.difficulty, state.mode);
            if (state.round < roundsToUse.length - 1) {
                state.round++;
                state.selected = null;
                state.revealed = false;
            } else {
                state.complete = true;
            }
            render();
        }

        function submitScore() {
            const nameInput = document.getElementById('playerNameInput');
            const name = nameInput.value.trim();
            
            const validation = isNameValid(name);
            
            if (!validation.valid) {
                state.nameError = validation.reason;
                render();
                return;
            }

            state.nameError = '';

            const timestamp = new Date().toISOString();
            const entry = {
                name: name,
                score: state.score,
                mode: state.mode,
                difficulty: state.difficulty,
                timestamp: timestamp
            };

            db.ref('scores').push(entry).then(() => {
                state.playerName = name;
                loadLeaderboard();
            }).catch(err => {
                console.error('Error submitting score:', err);
                state.nameError = 'Error saving score. Try again.';
                render();
            });
        }

        function loadLeaderboard() {
            db.ref('scores').orderByChild('score').limitToLast(100).once('value', (snapshot) => {
                const data = snapshot.val();
                state.leaderboard = [];
                if (data) {
                    Object.values(data).forEach(entry => {
                        state.leaderboard.push(entry);
                    });
                }
                state.leaderboard.sort((a, b) => b.score - a.score);
                render();
            });
        }

        document.addEventListener('keydown', (e) => {
    // If typing in an input field, only handle Enter for name submission
            if (document.activeElement.tagName === 'INPUT') {
                if (e.key === 'Enter') {
                    submitScore();
                }
                return;
            }
    
    // Game key controls only work during gameplay
            if (!state.gameStarted || state.complete) return;
    
            const key = e.key.toUpperCase();
            const numOptions = getNumOptions(state.mode);
    
            if (key === 'A') selectFact(0);
            else if (key === 'B') selectFact(1);
            else if (key === 'C' && numOptions >= 3) selectFact(2);
            else if (key === 'D' && numOptions >= 4) selectFact(3);
            else if (key === 'ENTER') {
                if (state.revealed && !state.complete) nextRound();
            }
        });
        
        function render() {
            const gameEl = document.getElementById('game');

            if (!state.gameStarted) {
                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Spot The Fake</h1>
                            <p class="subtitle">Can you tell real from misleading?</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="menu-section">
                            <h2>Select Game Mode</h2>
                            <button onclick="startGame('callmybluff')" style="margin-bottom: 10px;">Call My Bluff</button>
                            <p style="font-size: 12px; color: #666;">One real, one fake definition. Press A or B to choose.</p>
                            
                            <button onclick="startGame('spotfake')" style="margin-bottom: 10px; margin-top: 15px;">Spot The Fake</button>
                            <p style="font-size: 12px; color: #666;">Find the AI hallucination among 4 options. Press A, B, C, or D to choose.</p>
                        </div>

                        <div style="border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
                            <h2>Select Difficulty</h2>
                            <div class="difficulty-grid">
                                <button onclick="setDifficulty('easy')" class="difficulty-btn ${state.difficulty === 'easy' ? 'active' : 'inactive'}">Easy</button>
                                <button onclick="setDifficulty('medium')" class="difficulty-btn ${state.difficulty === 'medium' ? 'active' : 'inactive'}">Medium</button>
                                <button onclick="setDifficulty('hard')" class="difficulty-btn ${state.difficulty === 'hard' ? 'active' : 'inactive'}">Hard</button>
                            </div>
                            <p class="difficulty-desc">
                                ${state.difficulty === 'easy' ? 'Clear definitions, obvious fakes. Great for kids and beginners.' : 
                                  state.difficulty === 'medium' ? 'Tricky wording, plausible fakes. For intermediate players.' : 
                                  'Expert-level, deceptively realistic. For medical enthusiasts.'}
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.complete && !state.playerName) {
                gameEl.innerHTML = `
                    <div class="card game-over">
                        <h1>Game Complete!</h1>
                        <div class="final-score">${state.score} / 4</div>
                        <div class="message">
                            ${state.score === 4 ? "Perfect! You're a definition detective." : 
                              state.score === 3 ? "Excellent! You caught most of the tricks." :
                              state.score === 2 ? "Good effort! Misleading names are tough." :
                              "Keep practicing! These tricks are sneaky."}
                        </div>
                        <div style="margin: 20px 0;">
                            <input type="text" id="playerNameInput" placeholder="Enter your name" style="padding: 10px; width: 100%; border: 2px solid #4caf50; border-radius: 4px; font-size: 16px;">
                            ${state.nameError ? `<div class="error-message">${state.nameError}</div>` : ''}
                        </div>
                        <button onclick="submitScore()" style="margin-bottom: 10px;">Submit Score</button>
                        <button onclick="backToMenu()" style="background: #999; margin-bottom: 10px;">Back to Menu</button>
                        <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                    </div>
                `;
                return;
            }

            if (state.complete && state.playerName) {
                const rank = state.leaderboard.findIndex(e => e.name === state.playerName && e.score === state.score) + 1;
                let leaderboardHtml = '';
                state.leaderboard.slice(0, 10).forEach((entry, idx) => {
                    const isPlayer = entry.name === state.playerName && entry.score === state.score;
                    leaderboardHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: ${isPlayer ? '#fff9c4' : 'white'}; border-bottom: 1px solid #eee;">
                            <span>${idx + 1}. ${entry.name}</span>
                            <span style="font-weight: bold;">${entry.score}/4</span>
                        </div>
                    `;
                });

                gameEl.innerHTML = `
                    <div class="card game-over">
                        <h1>Game Complete!</h1>
                        <div class="final-score">${state.score} / 4</div>
                        <div class="message" style="font-size: 20px; color: #ff9800;">You ranked #${rank} on the leaderboard!</div>
                        <div style="background: #f5f5f5; border-radius: 8px; padding: 15px; margin: 20px 0;">
                            <div style="font-weight: bold; margin-bottom: 10px;">Top 10 Scores</div>
                            ${leaderboardHtml}
                        </div>
                        <button onclick="backToMenu()" style="margin-bottom: 10px;">Play Again</button>
                        <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                    </div>
                `;
                return;
            }

            const roundsToUse = getRounds(state.difficulty, state.mode);
            
            if (state.mode === 'spotfake') {
                const round = roundsToUse[state.round];
                let factsHtml = '';
                
                round.facts.forEach((fact, idx) => {
                    let classes = 'fact';
                    if (state.revealed) {
                        if (fact.fake && state.selected === idx) classes += ' correct';
                        else if (!fact.fake && state.selected === idx) classes += ' wrong';
                        else if (fact.fake) classes += ' wrong';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && fact.fake) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ AI-GENERATED FAKE</span>' : '<span class="fact-badge badge-fake">AI FAKE</span>';
                    } else if (state.revealed && !fact.fake && state.selected === idx) {
                        badge = '<span class="fact-badge badge-real">✓ REAL</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name"><span style="display: inline-block; min-width: 30px; font-weight: bold; color: #ff9800;">${letter}.</span> ${fact.name}</div>
                            <div class="fact-desc">${fact.desc}</div>
                            ${badge}
                        </div>
                    `;
                });

                let explanation = '';
                if (state.revealed) {
                    explanation = `
                        <div class="explanation show">
                            <div class="explanation-title">Why was it fake?</div>
                            <div class="explanation-text">${round.explain}</div>
                        </div>
                    `;
                }

                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Spot The Fake</h1>
                            <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                        </div>
                        <div class="score">
                            <div class="score-label">Score</div>
                            <div class="score-value">${state.score}/4</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="round-info">
                            <div class="round-title">${round.title}</div>
                            <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                        </div>
                        <div class="instructions">3 of these are REAL medical conditions. 1 is completely made up by AI. Which one is fake?</div>
                        <div class="instructions" style="font-size: 12px; color: #999;">Press A, B, C, or D on your keyboard to select</div>
                        <div class="facts">
                            ${factsHtml}
                        </div>
                        ${explanation}
                        ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
                    </div>
                    <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
                    <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                `;
            } else {
                const round = roundsToUse[state.round];
                const pair = round.pairs[0];
                
                let factsHtml = `
                    <div style="margin-bottom: 20px;">
                        <div style="background: #f0f7e8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #4caf50;">${pair.condition}</div>
                            <div style="font-size: 14px; color: #666;">Which definition is correct?</div>
                        </div>
                    </div>
                `;

                [pair.real, pair.fake].forEach((definition, idx) => {
                    const isCorrect = (idx === 0) === pair.correctIsReal;
                    let classes = 'fact';
                    
                    if (state.revealed) {
                        if (isCorrect && state.selected === idx) classes += ' correct';
                        else if (!isCorrect && state.selected === idx) classes += ' wrong';
                        else if (isCorrect) classes += ' wrong';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && !isCorrect) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ WRONG</span>' : '<span class="fact-badge badge-fake">FAKE</span>';
                    } else if (state.revealed && isCorrect && state.selected === idx) {
                        badge = '<span class="fact-badge badge-real">✓ CORRECT</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name">${letter}. ${idx === 0 ? 'Definition A' : 'Definition B'}</div>
                            <div class="fact-desc">${definition}</div>
                            ${badge}
                        </div>
                    `;
                });

                let explanation = '';
                if (state.revealed) {
                    explanation = `
                        <div class="explanation show">
                            <div class="explanation-title">Why?</div>
                            <div class="explanation-text">${round.explain}</div>
                        </div>
                    `;
                }

                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Call My Bluff</h1>
                            <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                        </div>
                        <div class="score">
                            <div class="score-label">Score</div>
                            <div class="score-value">${state.score}/4</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="round-info">
                            <div class="round-title">${round.title}</div>
                            <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                        </div>
                        <div class="instructions">Pick the correct definition.</div>
                        <div class="instructions" style="font-size: 12px; color: #999;">Press A or B on your keyboard to select</div>
                        <div class="facts">
                            ${factsHtml}
                        </div>
                        ${explanation}
                        ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
                    </div>
                    <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
                    <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                `;
            }
        }

        loadLeaderboard();
        render();
    </script>
</body>
</html>
