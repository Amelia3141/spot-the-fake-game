<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot The Fake - Medical AI Detection</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #e8f5e9;
            --card-bg: white;
            --border-primary: #4caf50;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --accent: #ff9800;
            --correct: #4caf50;
            --wrong: #f44336;
            --shadow: rgba(0,0,0,0.1);
            --option-a: #FF9AA2;
            --option-b: #70D6FF;
            --option-c: #C49BFF;
            --option-d: #FFE380;
            --enter-green: #A8E6CF;
            --hint-bg: #fff3e0;
            --hint-border: #ff9800;
        }
        
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --card-bg: #2a2a2a;
            --border-primary: #66bb6a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #707070;
            --shadow: rgba(0,0,0,0.3);
            --option-a: #FFADB3;
            --option-b: #85DFFF;
            --option-c: #D4B0FF;
            --option-d: #FFED9A;
            --enter-green: #B8F0DC;
            --hint-bg: rgba(255, 152, 0, 0.15);
            --hint-border: #ffa726;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%); 
            color: var(--text-primary); 
            padding: 20px; 
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
        }
        
        .header-left { display: flex; flex-direction: column; }
        .header-right { display: flex; gap: 20px; align-items: center; }
        
        h1 { font-size: 32px; margin-bottom: 5px; }
        h2 { font-size: 24px; margin-bottom: 15px; }
        
        .subtitle { color: var(--text-secondary); font-size: 14px; }
        
        .score { text-align: right; }
        .score-label { font-size: 12px; color: var(--text-muted); }
        .score-value { font-size: 36px; font-weight: bold; }
        
        .streak-display {
            background: linear-gradient(135deg, var(--accent) 0%, var(--correct) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .streak-display.hidden { display: none; }
        
        .dark-mode-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.05);
        }
        
        .card { 
            background: var(--card-bg); 
            border: 2px solid var(--border-primary); 
            border-radius: 12px; 
            padding: 30px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.3s, border 0.3s;
        }
        
        .hints-box {
            background: var(--hint-bg);
            border: 2px solid var(--hint-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .hints-title {
            font-weight: bold;
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .hints-list {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .hints-list li {
            margin-bottom: 6px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--correct) 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .round-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        
        .round-title { font-size: 20px; font-weight: bold; }
        .round-number { 
            background: var(--border-primary); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
        }
        
        .timer-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
            padding: 10px 20px;
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .timer-display.warning { 
            color: var(--wrong); 
            border-color: var(--wrong);
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .lives-display {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .life-icon {
            font-size: 24px;
            transition: all 0.3s;
        }
        
        .life-icon.lost {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        
        .instructions { 
            color: var(--text-secondary); 
            margin-bottom: 20px; 
            font-size: 14px; 
        }
        
        .facts { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .fact { 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s;
            position: relative;
        }
        
        .fact:hover:not(.disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px var(--shadow); 
        }
        
        .fact-name { 
            font-weight: bold; 
            font-size: 16px; 
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fact-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            color: white;
        }
        
        .letter-a { background: var(--option-a); }
        .letter-b { background: var(--option-b); }
        .letter-c { background: var(--option-c); }
        .letter-d { background: var(--option-d); }
        
        .fact-desc { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.6;
        }
        
        .fact.selected { 
            border-color: var(--border-primary); 
            background: rgba(76, 175, 80, 0.1); 
        }
        
        .fact.correct { 
            border-color: var(--correct); 
            background: rgba(76, 175, 80, 0.2); 
        }
        
        .fact.wrong { 
            border-color: var(--wrong); 
            background: rgba(244, 67, 54, 0.1); 
        }
        
        .fact.disabled { cursor: not-allowed; opacity: 0.7; }
        
        .fact-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-fake {
            background: var(--wrong);
            color: white;
        }
        
        .badge-real {
            background: var(--correct);
            color: white;
        }
        
        .explanation { 
            background: rgba(76, 175, 80, 0.1); 
            border: 2px solid var(--correct); 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .explanation.show {
            max-height: 500px;
            opacity: 1;
        }
        
        .explanation-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--correct);
        }
        
        .explanation-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        button { 
            background: linear-gradient(135deg, var(--border-primary) 0%, var(--correct) 100%); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            transition: all 0.3s;
        }
        
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .game-over { text-align: center; }
        .final-score { font-size: 64px; font-weight: bold; color: var(--correct); margin: 20px 0; }
        .message { font-size: 18px; margin-bottom: 20px; }
        
        .lesson { 
            background: #fff3e0; 
            border: 2px solid var(--accent); 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 20px; 
            font-size: 13px;
        }
        
        body.dark-mode .lesson {
            background: rgba(255, 152, 0, 0.15);
        }
        
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .mode-card {
            background: var(--card-bg);
            border: 2px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .mode-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .mode-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .mode-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .difficulty-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .difficulty-btn { padding: 12px; font-size: 14px; }
        .difficulty-btn.active { background: var(--correct); }
        .difficulty-btn.inactive { background: #ddd; color: #333; }
        .difficulty-btn:hover { transform: none; }
        
        .menu-section { margin-bottom: 30px; }
        .difficulty-desc { font-size: 12px; color: var(--text-secondary); margin-top: 10px; }
        .error-message { color: var(--wrong); font-size: 12px; margin-top: 5px; }
        
        input { 
            font-family: inherit;
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-primary);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
        }
        
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .header-right { flex-direction: column; margin-top: 15px; }
            .score { margin-top: 15px; }
            h1 { font-size: 24px; }
            .difficulty-grid { grid-template-columns: 1fr; }
            .mode-selection { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div id="game"></div>
    </div>
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUdAqlDwN_1lRlbBHaA37RPscAtuxIXTA",
            authDomain: "spot-fake-game.firebaseapp.com",
            databaseURL: "https://spot-fake-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spot-fake-game",
            storageBucket: "spot-fake-game.firebasestorage.app",
            messagingSenderId: "141455787893",
            appId: "1:141455787893:web:e94feb2716c98336f1753c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // GAME STATE
        let state = {
            screen: 'menu',
            gameMode: 'classic',
            difficulty: null,
            gameType: null,
            round: 0,
            score: 0,
            selected: null,
            revealed: false,
            playerName: '',
            streak: 0,
            bestStreak: 0,
            lives: 3,
            timer: 30,
            timerInterval: null,
            startTime: null,
            darkMode: false,
            callMyBluffOrder: null,
            leaderboard: []
        };

        // NAME VALIDATION
        const blockedWords = [
            'f4g', 'fagg', 'n1gg', 'nigg', 'sh1t', 'shitt', 
            'kys', 'kill', 'die', 'slut', 'whore', 'cunt'
        ];

        const whitelistedNames = [
            'assana', 'assane', 'shaniqua', 'gaylord', 'dick', 'dickson', 
            'fanny', 'fannie', 'shitley', 'damn', 'dammit', 'ass'
        ];

        function isNameValid(name) {
            const lower = name.toLowerCase().trim();
            
            if (lower.length < 2 || lower.length > 30) {
                return { valid: false, reason: 'Name must be 2-30 characters' };
            }
            
            for (let word of blockedWords) {
                if (lower.includes(word)) {
                    return { valid: false, reason: 'Name contains restricted content' };
                }
            }
            
            const profanityPatterns = [
                { regex: /shit/i, safe: false },
                { regex: /fuck/i, safe: false },
                { regex: /damn/i, safe: false },
                { regex: /ass(?!ana|ane)/i, safe: false },
                { regex: /dick(?!inson|son)/i, safe: false },
                { regex: /dick$/i, safe: true },
                { regex: /fanny$/i, safe: true },
                { regex: /^hell/i, safe: false },
                { regex: /bitch/i, safe: false }
            ];
            
            for (let pattern of profanityPatterns) {
                if (pattern.regex.test(lower)) {
                    const isWhitelisted = whitelistedNames.some(wl => 
                        lower === wl.toLowerCase() || lower.includes(wl.toLowerCase())
                    );
                    if (!isWhitelisted && !pattern.safe) {
                        return { valid: false, reason: 'Name contains restricted content' };
                    }
                }
            }
            
            if (/(.)\1{4,}/.test(lower)) {
                return { valid: false, reason: 'Name contains too many repeated characters' };
            }
            
            if (!/[a-z]/i.test(lower)) {
                return { valid: false, reason: 'Name must contain at least one letter' };
            }
            
            return { valid: true };
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // GAME DATA - AI TRUSTWORTHINESS FOCUSED
        const easySpotRounds = [
            {
                title: 'Round 1: Learning the Clues',
                hints: [
                    '🔍 AI often makes up exact percentages like "2.3%" or "1 in 8,000"',
                    '🎯 Watch for impossible claims that sound too amazing',
                    '📊 Real medical facts usually say "about" or "roughly" instead of exact numbers'
                ],
                facts: shuffleArray([
                    { name: 'Brain Freeze', desc: 'The headache from eating ice cream too fast happens when cold hits the roof of your mouth. This makes blood vessels in your head quickly squeeze and then expand, which triggers pain.', fake: false },
                    { name: 'Hiccups', desc: 'Hiccups are caused by your diaphragm muscle having spasms. The longest case of hiccups ever recorded lasted 68 years.', fake: false },
                    { name: 'Growing Pains', desc: 'Kids sometimes feel aches in their legs at night as they grow. This is normal and usually goes away as they get older.', fake: false },
                    { name: 'Color Taste Syndrome', desc: 'A condition affecting exactly 1.7% of children worldwide where the brain makes kids taste colors in their mouth. Red things taste spicy, blue things taste sweet, and yellow things taste sour.', fake: true }
                ]),
                explain: '**Color Taste Syndrome** is AI-generated. Red flags: The exact percentage "1.7%" (AI loves fake precision), the too-perfect pattern (each color = one taste), and the made-up scientific name. Real conditions are messy, not this neat!'
            },
            {
                title: 'Round 2: Spotting Fake Patterns',
                hints: [
                    '⚠️ Be suspicious when something sounds TOO organized or perfect',
                    '🤖 AI makes up names by combining real medical words',
                    '✨ Real medicine rarely has "magical" solutions that fix everything'
                ],
                facts: shuffleArray([
                    { name: 'Goosebumps', desc: 'Your skin gets bumpy when you\'re cold or scared. This happens because tiny muscles pull on your hair follicles. It\'s left over from when our ancestors had more body hair.', fake: false },
                    { name: 'Yawning', desc: 'When you yawn, you take in a big breath of air. Yawning is contagious - seeing someone yawn often makes you yawn too! Scientists think it helps wake up your brain.', fake: false },
                    { name: 'Rainbow Vision Effect', desc: 'After looking at bright lights, you might see colored spots or shapes. These usually go away after blinking a few times.', fake: false },
                    { name: 'Digital Eye Syndrome', desc: 'Looking at screens for 47 minutes or longer causes temporary loss of color vision for exactly 12 minutes. This affects 94.6% of children who use tablets and requires special green-tinted glasses to prevent.', fake: true }
                ]),
                explain: '**Digital Eye Syndrome** is fake! Red flags: Super specific numbers (47 min, 12 min, 94.6%), too-perfect timing, and a magic solution (special glasses). Real screen problems cause tiredness and dry eyes, but don\'t make you lose color vision!'
            },
            {
                title: 'Round 3: Testing Your Skills',
                hints: [
                    '🔬 Real conditions don\'t have perfect mathematical patterns',
                    '💭 If it sounds like a superhero power, it\'s probably fake',
                    '📝 Check if the description uses lots of big science words without explaining them'
                ],
                facts: shuffleArray([
                    { name: 'Butterflies in Your Stomach', desc: 'When you\'re nervous or excited, your stomach can feel fluttery. This happens because your body is getting ready for action by sending blood to your muscles.', fake: false },
                    { name: 'Pins and Needles', desc: 'Your foot or hand can feel tingly and numb if you sit or lie in one position too long. This happens when pressure stops blood flowing normally, but it goes away quickly.', fake: false },
                    { name: 'Sleepwalking', desc: 'Some people get up and walk around while they\'re still asleep. They usually don\'t remember it in the morning. It\'s most common in children.', fake: false },
                    { name: 'Temperature Reading Ability', desc: 'One in every 2,500 people are born with specialized skin sensors that let them detect the exact temperature of any object within 0.1 degrees just by looking at it. This ability strengthens with practice.', fake: true }
                ]),
                explain: '**Temperature Reading Ability** is made up! Red flags: Exact fraction (1 in 2,500), impossible precision (0.1 degrees "just by looking"), and the claim it gets better with practice. You can\'t develop superpowers! Real temperature sensing requires touch.'
            },
            {
                title: 'Round 4: You\'re an Expert Now!',
                hints: [
                    '👁️ Look carefully at any exact statistics or percentages',
                    '⚡ Real bodies are unpredictable - be suspicious of perfect patterns',
                    '🎪 If it sounds like magic or a cartoon superpower, it\'s likely AI-generated'
                ],
                facts: shuffleArray([
                    { name: 'Blushing', desc: 'Your face turns red when you\'re embarrassed because blood rushes to your cheeks. This is an automatic reaction you can\'t control.', fake: false },
                    { name: 'Pruney Fingers', desc: 'Your fingers and toes get wrinkly after being in water for a while. Scientists think this gives you better grip on wet objects.', fake: false },
                    { name: 'Dizzy Spells', desc: 'Standing up too fast can make you feel dizzy or see spots. This happens because blood takes a moment to reach your brain. Sitting back down helps it pass.', fake: false },
                    { name: 'Musical Memory Syndrome', desc: 'Affects approximately 3.8% of children aged 8-12, causing them to remember only information presented in song form. Speaking the same information results in zero retention, but singing achieves 100% recall every time.', fake: true }
                ]),
                explain: '**Musical Memory Syndrome** is AI nonsense! Red flags: Fake precision (3.8%, ages 8-12), impossible absolutes (zero retention vs 100% recall), and too-perfect opposites. Real memory doesn\'t work in such extreme, mathematical patterns. Music CAN help memory, but not this magically!'
            }
        ];

        const mediumSpotRounds = [
            {
                title: 'Round 1: Intermediate Detection',
                hints: [
                    'AI often creates plausible-sounding mechanisms that don\'t match real biology',
                    'Watch for conditions with suspiciously convenient timelines or measurements',
                    'Real rare conditions have messy, variable presentations'
                ],
                facts: shuffleArray([
                    { name: 'Exploding Head Syndrome', desc: 'People hear loud explosion sounds or crashes when falling asleep or waking up. Despite the scary name, it\'s completely harmless but can be very frightening the first time it happens.', fake: false },
                    { name: 'Ice Pick Headache', desc: 'Sharp, stabbing pains that last only a few seconds, feeling like an ice pick stabbing the head. They\'re sudden, intense, and usually don\'t need treatment.', fake: false },
                    { name: 'Foreign Accent Syndrome', desc: 'After brain injury or stroke, people can suddenly speak with a different accent they never had before. It\'s caused by damage to brain areas controlling speech patterns.', fake: false },
                    { name: 'Sensory Crosswire Disorder', desc: 'A neurological condition where sensory signals swap pathways every 90 minutes in precise cycles. Patients taste sounds, hear colors, then revert to normal, repeating this pattern with clock-like regularity throughout the day.', fake: true }
                ]),
                explain: '**Sensory Crosswire Disorder** is fabricated. Red flags: Clock-like 90-minute cycles (biology isn\'t that precise), reversible sensory swapping on a timer, and multiple different synesthesias alternating predictably. Real synesthesia is consistent, not cyclical.'
            },
            {
                title: 'Round 2: Subtle AI Tells',
                hints: [
                    'Genuine conditions rarely have multiple symptoms that perfectly mirror each other',
                    'Be skeptical of statistics that seem designed to be memorable',
                    'Real medical progression is gradual, not step-wise or instantaneous'
                ],
                facts: shuffleArray([
                    { name: 'Mirror-Touch Synesthesia', desc: 'People physically feel what they see others experiencing. Watching someone get touched on the arm makes them feel it on their own arm in the same spot.', fake: false },
                    { name: 'Alice in Wonderland Syndrome', desc: 'Objects appear much larger or smaller than they really are, and body parts feel like they\'re changing size. Often triggered by migraines or infections in children.', fake: false },
                    { name: 'Hyperthymesia', desc: 'An extremely rare ability to remember every day of your life in vivid detail. People with this condition can tell you what day of the week any past date fell on and what they did that day.', fake: false },
                    { name: 'Symmetrical Symptom Disorder', desc: 'A condition where any symptom that appears on one side of the body manifests identically on the opposite side exactly 6 hours later. Documented in roughly 1 in 15,000 individuals, it affects pain, rashes, and numbness with perfect bilateral timing.', fake: true }
                ]),
                explain: '**Symmetrical Symptom Disorder** is AI-generated. Red flags: Perfect 6-hour delay (too precise), exact mirror symptoms across all types, and the "roughly 1 in 15,000" fake precision. Real bilateral symptoms appear simultaneously or randomly, not on a precise schedule.'
            },
            {
                title: 'Round 3: Complex Patterns',
                hints: [
                    'Real disorders show individual variation - identical presentations across patients is suspicious',
                    'Check whether proposed mechanisms actually match known physiology',
                    'Multiple precise numbers in one description often signal AI fabrication'
                ],
                facts: shuffleArray([
                    { name: 'Capgras Delusion', desc: 'People believe their loved ones have been replaced by identical imposters. They recognize faces but feel no emotional connection, creating the certainty it\'s someone else.', fake: false },
                    { name: 'Prosopagnosia', desc: 'Face blindness - people cannot recognize faces, even of close family members. Some can\'t recognize their own face in a mirror and must identify people by voice or clothing.', fake: false },
                    { name: 'Cotard Delusion', desc: 'People believe they\'re dead or don\'t exist. Some think they\'ve lost their blood or organs. Despite feeling "dead," they continue walking and talking.', fake: false },
                    { name: 'Cascading Amnesia Pattern', desc: 'A memory disorder where patients lose memories in reverse chronological order at a consistent rate of one year per week. After 20 weeks, memories stabilize at age 20, regardless of current age. Shows 87% correlation with vitamin B12 deficiency.', fake: true }
                ]),
                explain: '**Cascading Amnesia Pattern** is fake. Red flags: Perfect mathematical progression (one year per week), universal stabilization point (age 20), and specific correlation percentage (87%). Real amnesia is chaotic and unpredictable, not formula-driven. The B12 detail adds fake credibility.'
            },
            {
                title: 'Round 4: Advanced Challenge',
                hints: [
                    'AI combines real medical concepts incorrectly to sound credible',
                    'Treatment descriptions that are too simple for complex conditions are suspicious',
                    'Watch for descriptions that mix unrelated physiological systems'
                ],
                facts: shuffleArray([
                    { name: 'Synesthesia', desc: 'Stimulation of one sense triggers another. People might see colors when hearing music, taste words, or feel textures when looking at certain colors. It\'s a genuine neurological wiring difference.', fake: false },
                    { name: 'Hemispatial Neglect', desc: 'After certain brain injuries, people ignore one entire half of their world. They might only eat from one side of their plate or only dress one side of their body.', fake: false },
                    { name: 'Phantom Limb Syndrome', desc: 'After amputation, people continue feeling their missing limb is still there. They can experience pain, itching, or sensation in body parts that no longer exist.', fake: false },
                    { name: 'Circadian Reversal Syndrome', desc: 'A disorder where the body\'s clock flips exactly 12 hours every 2 weeks. Patients experience normal sleep from weeks 1-2, complete day-night reversal weeks 3-4, then reset. Affects core temperature, hormone release, and alertness in synchronized 14-day cycles across all patients.', fake: true }
                ]),
                explain: '**Circadian Reversal Syndrome** is fabricated. Red flags: Perfect 12-hour/2-week mathematical cycle, identical timing across all patients, complete system synchronization. Real circadian disorders show individual variation and don\'t flip on precise schedules. The mechanistic details sound scientific but describe impossible biology.'
            }
        ];

        const hardSpotRounds = [
            {
                title: 'Round 1: Advanced Detection',
                hints: [
                    'Examine whether proposed pathophysiology aligns with established medical knowledge',
                    'Statistical clustering or prevalence patterns may reveal fabrication'
                ],
                facts: shuffleArray([
                    { name: 'Kleine-Levin Syndrome', desc: 'Sleeping Beauty Syndrome - recurring episodes of excessive sleep lasting days to weeks. Patients wake briefly to eat and use bathroom before falling back asleep. Episodes can recur for years.', fake: false },
                    { name: 'Kuru', desc: 'A prion disease causing uncontrollable laughing and tremors, historically found among Papua New Guinea tribes who practiced mortuary cannibalism. The "laughing death" was transmitted through consuming infected brain tissue.', fake: false },
                    { name: 'Takotsubo Cardiomyopathy', desc: 'Broken Heart Syndrome - extreme emotional stress temporarily reshapes the heart into a balloon-like shape mimicking a heart attack. Named after Japanese octopus traps due to the cardiac imaging appearance.', fake: false },
                    { name: 'Metabolic Echo Phenomenon', desc: 'A mitochondrial disorder where cellular ATP production shows delayed oscillating patterns. Initial energy use triggers secondary depletion exactly 73 minutes later, with amplitude decreasing by precisely 15% per cycle. Responds specifically to thiamine doses of 200mg administered at 2.5 hour intervals.', fake: true }
                ]),
                explain: '**Metabolic Echo Phenomenon** is AI hallucination. Red flags: Suspiciously precise timing (73 min), mathematical decay pattern (exactly 15% per cycle), and overly specific treatment protocol. Real mitochondrial disorders show variable presentations, not clock-work cellular mechanics with such neat numerical patterns.'
            },
            {
                title: 'Round 2: Sophisticated Fabrication',
                hints: [
                    'Consider whether symptom clusters follow known neural or physiological pathways',
                    'Epidemiological data that\'s too specific or patterned suggests AI generation'
                ],
                facts: shuffleArray([
                    { name: 'Fatal Familial Insomnia', desc: 'A prion disease causing progressive, complete inability to sleep. Over months, patients lose sleep capacity entirely, experiencing hallucinations, dementia, and autonomic dysfunction. Universally fatal with no treatment.', fake: false },
                    { name: 'Fregoli Delusion', desc: 'Opposite of Capgras - patients believe different people are actually one person in disguise. They think someone is following them by constantly changing appearance and identity.', fake: false },
                    { name: 'Stendhal Syndrome', desc: 'Exposure to exceptional art or beauty triggers rapid heartbeat, dizziness, confusion, and even hallucinations. First documented in Florence among tourists viewing Renaissance masterpieces.', fake: false },
                    { name: 'Cognitive Bifurcation Disorder', desc: 'A neurological split where patients develop two distinct cognitive processing modes operating in 40-minute alternating cycles. Mode A shows enhanced analytical reasoning with suppressed emotional processing; Mode B shows reverse pattern. Brain imaging reveals alternating hemispheric dominance with 92% accuracy in predicting transitions.', fake: true }
                ]),
                explain: '**Cognitive Bifurcation Disorder** is fabricated. Red flags: Perfect 40-minute cycles, mutually exclusive cognitive modes, predictable hemispheric switching (92% accuracy), and oversimplified left/right brain dichotomy. Real cognitive variations occur along continua, not binary switches, and brains don\'t alternate hemispheric dominance on timers.'
            },
            {
                title: 'Round 3: Expert-Level Analysis',
                hints: [
                    'Evaluate whether genetic or biochemical mechanisms described actually exist',
                    'Real rare diseases have messy inheritance patterns and variable expressivity'
                ],
                facts: shuffleArray([
                    { name: 'Trimethylaminuria', desc: 'Fish Odor Syndrome - metabolic disorder preventing breakdown of trimethylamine compounds. Patients emit strong fish-like odor from breath, sweat, and urine due to enzyme deficiency. No cure, only dietary management.', fake: false },
                    { name: 'Porphyria', desc: 'Vampire Disease - group of disorders affecting heme synthesis. Some variants cause extreme photosensitivity with severe blisters from sun exposure. Skin can become fragile and discolored. May have inspired vampire legends.', fake: false },
                    { name: 'Fibrodysplasia Ossificans Progressiva', desc: 'Muscles and connective tissue gradually turn into bone. Any injury triggers bone formation. Eventually, patients become immobilized as second skeleton forms. Caused by ACVR1 gene mutation. No effective treatment.', fake: false },
                    { name: 'Progressive Enzyme Sequencing Disorder', desc: 'A metabolic condition where digestive enzymes activate in reverse order every 4th day. Days 1-3 show normal digestion; day 4 experiences lipase activating before amylase and pepsin, causing cyclical malabsorption. Prevalence of 1.3 per 100,000 in Scandinavian populations, linked to CYP2D6*17 allele variant.', fake: true }
                ]),
                explain: '**Progressive Enzyme Sequencing Disorder** is AI-generated. Red flags: Precise 4-day cycle, specific population prevalence (1.3 per 100,000), named gene variant (CYP2D6*17), and mechanistically impossible reversed enzyme cascade. Real digestive enzyme disorders don\'t follow timed cycles, and enzyme activation order is biochemically determined, not reversible on schedules.'
            },
            {
                title: 'Round 4: Ultimate Challenge',
                hints: [
                    'Scrutinize whether described cellular/molecular mechanisms could physically occur',
                    'Overly tidy symptom presentations across patient populations indicate fabrication'
                ],
                facts: shuffleArray([
                    { name: 'Urbach-Wiethe Disease', desc: 'Lipoid proteinosis causes calcium deposits in brain\'s amygdala. Patients lose ability to feel fear. They can\'t recognize fear in others\' faces and don\'t experience fear themselves, even in dangerous situations.', fake: false },
                    { name: 'Ehlers-Danlos Syndrome', desc: 'Connective tissue disorder causing hyperflexible joints and stretchy skin. Severe cases experience frequent dislocations, organ rupture risk, and chronic pain. Caused by collagen production defects.', fake: false },
                    { name: 'Hutchinson-Gilford Progeria', desc: 'Genetic condition causing rapid aging in children. Kids appear elderly by age 10, developing cardiovascular disease, joint problems, and hair loss. Age 8-10 times faster than normal. Most don\'t survive past teens.', fake: false },
                    { name: 'Neuroplastic Oscillation Syndrome', desc: 'A synaptic disorder where neural pruning and genesis alternate in 21-day cycles with 96% periodicity consistency. Cognitive function peaks mid-genesis phase, declines during pruning. MRI shows synchronized hippocampal volume changes of 0.3cc between phases. Treatment requires timed administration of neurotrophin-3 analogs based on cycle phase mapping.', fake: true }
                ]),
                explain: '**Neuroplastic Oscillation Syndrome** is AI hallucination. Red flags: Impossibly precise 21-day cycles (96% consistency), measurable volume oscillations (0.3cc), synchronized bilateral changes, and overly specific treatment targeting "cycle phase." Real neuroplasticity is continuous and variable, not cyclical. The technical language sounds sophisticated but describes neurobiologically impossible timing mechanisms.'
            }
        ];

        const easyCallRounds = [
            {
                title: 'Round 1: Basic Terms',
                hints: [
                    '💡 Simple medical words usually describe what you see or feel',
                    '🎯 Watch out for definitions that sound too complicated for a simple word',
                    '🤔 If it doesn\'t match what you know from real life, it might be fake'
                ],
                pairs: [
                    {
                        condition: 'Fever',
                        real: 'When your body temperature is higher than normal, usually because you\'re sick. Your body feels hot and you might need medicine to cool down.',
                        fake: 'A temporary condition where your temperature drops below normal and you feel very cold and need extra blankets to stay warm.',
                        correctIsReal: true
                    }
                ],
                explain: 'A fever means you\'re HOT, not cold! The fake definition switched the temperature direction to trick you. This is a common AI error - reversing key facts while keeping other details correct.'
            },
            {
                title: 'Round 2: Common Health Words',
                hints: [
                    '⚠️ AI might mix up opposite meanings (hot vs cold, up vs down)',
                    '📚 Think about what you\'ve heard doctors or parents say',
                    '✅ The real definition should make sense with how the word is actually used'
                ],
                pairs: [
                    {
                        condition: 'Contagious',
                        real: 'When a sickness can spread from one person to another, like catching a cold from your friend.',
                        fake: 'When you feel tired and need to rest your body by taking a nap or going to bed early.',
                        correctIsReal: true
                    }
                ],
                explain: 'Contagious means it can SPREAD to others - nothing to do with being tired! The fake answer describes something completely different (fatigue) using confident language to seem correct.'
            },
            {
                title: 'Round 3: Body Functions',
                hints: [
                    '🔍 Check if the definition matches what actually happens in your body',
                    '🚨 Be suspicious if simple words get complicated explanations',
                    '💭 Trust what you know from experience'
                ],
                pairs: [
                    {
                        condition: 'Dizzy',
                        real: 'Feeling like the room is spinning around you or like you might fall over.',
                        fake: 'Having pain in your head that makes it hard to think clearly or focus on tasks.',
                        correctIsReal: true
                    }
                ],
                explain: 'Dizzy is about SPINNING or balance problems, not head pain! The fake definition describes a headache instead. AI often swaps one medical term\'s meaning for another related term.'
            },
            {
                title: 'Round 4: Final Test',
                hints: [
                    '👀 Does the definition actually explain what the word means?',
                    '🎪 Watch for definitions that talk about something totally different',
                    '⭐ You\'ve learned to spot AI tricks - trust your skills!'
                ],
                pairs: [
                    {
                        condition: 'Rash',
                        real: 'Red, bumpy, or itchy spots that appear on your skin.',
                        fake: 'When your nose is blocked and you can\'t breathe through it easily.',
                        correctIsReal: true
                    }
                ],
                explain: 'A rash is on your SKIN, not in your nose! The fake definition describes a stuffy nose instead. This is a classic AI error - giving a definition for a completely different symptom while sounding confident.'
            }
        ];

        const mediumCallRounds = [
            {
                title: 'Round 1: Medical Terminology',
                hints: [
                    'Check if technical terms are used correctly in their proper context',
                    'AI may mix similar-sounding conditions or swap related symptoms'
                ],
                pairs: [
                    {
                        condition: 'Edema',
                        real: 'Swelling caused by excess fluid trapped in body tissues. Commonly occurs in feet, ankles, and legs.',
                        fake: 'Inflammation of joint cartilage causing stiffness and reduced range of motion. Commonly affects knees and hips in patients over 40.',
                        correctIsReal: true
                    }
                ],
                explain: 'Edema is FLUID accumulation (swelling), not joint inflammation. The fake definition describes arthritis instead. AI confidently substituted a different condition while maintaining medical language to seem authoritative.'
            },
            {
                title: 'Round 2: Diagnostic Terms',
                hints: [
                    'Consider whether cause-and-effect relationships make physiological sense',
                    'Watch for plausible-sounding mechanisms that don\'t match the actual condition'
                ],
                pairs: [
                    {
                        condition: 'Tachycardia',
                        real: 'Abnormally fast heart rate, typically over 100 beats per minute while at rest. Can be felt as heart pounding or racing.',
                        fake: 'Irregular heart rhythm where heartbeats occur in pairs followed by abnormal pauses. Creates a distinct "double-beat, skip" pattern on ECG.',
                        correctIsReal: true
                    }
                ],
                explain: 'Tachycardia means FAST heart rate, not irregular rhythm. The fake definition describes a different arrhythmia pattern (bigeminy). AI mixed up two separate cardiac conditions with confident medical details.'
            },
            {
                title: 'Round 3: Symptom Descriptions',
                hints: [
                    'Evaluate if symptom progressions follow logical physiological patterns',
                    'Suspiciously specific timelines or measurements may indicate fabrication'
                ],
                pairs: [
                    {
                        condition: 'Orthostatic Hypotension',
                        real: 'Blood pressure drops significantly when standing up from sitting or lying down, causing dizziness or lightheadedness.',
                        fake: 'Blood pressure gradually increases throughout the day, peaking between 6-8 PM regardless of activity level, then normalizes overnight.',
                        correctIsReal: true
                    }
                ],
                explain: 'Orthostatic hypotension is about blood pressure DROP with position change, not daily cycles. The fake definition invented a circadian pattern with specific timing (6-8 PM). Real orthostatic hypotension is position-dependent, not time-dependent.'
            },
            {
                title: 'Round 4: Complex Conditions',
                hints: [
                    'Assess whether described mechanisms align with actual anatomical systems',
                    'AI may combine real medical concepts in physiologically impossible ways'
                ],
                pairs: [
                    {
                        condition: 'Nystagmus',
                        real: 'Involuntary, rapid, rhythmic eye movements. Eyes may move side-to-side, up-and-down, or in circular patterns.',
                        fake: 'Progressive vision loss starting peripherally and moving centrally over 5-7 years. Patients first lose night vision, then color perception, finally central detail.',
                        correctIsReal: true
                    }
                ],
                explain: 'Nystagmus is EYE MOVEMENT disorder, not progressive vision loss. The fake definition describes retinitis pigmentosa progression with specific timeframes. AI substituted a completely different ophthalmologic condition with detailed but irrelevant sequential symptoms.'
            }
        ];

        const hardCallRounds = [
            {
                title: 'Round 1: Advanced Pathophysiology',
                hints: [
                    'Verify cellular/molecular mechanisms against established biochemistry',
                    'Statistically precise claims may reveal AI generation'
                ],
                pairs: [
                    {
                        condition: 'Myasthenia Gravis',
                        real: 'Autoimmune disorder where antibodies attack acetylcholine receptors at neuromuscular junction. Causes progressive muscle weakness that worsens with activity and improves with rest.',
                        fake: 'Autoimmune disorder affecting myelin-producing oligodendrocytes in peripheral nerves. Antibodies target MOG protein, causing weakness that follows a distal-to-proximal pattern over precisely 6-month intervals.',
                        correctIsReal: true
                    }
                ],
                explain: 'Myasthenia Gravis affects the NEUROMUSCULAR JUNCTION, not myelin. The fake definition confused it with variants of peripheral demyelinating disorders, added fake specificity (6-month intervals), and referenced MOG protein (relevant to different conditions). AI mixed multiple neurological disorders.'
            },
            {
                title: 'Round 2: Diagnostic Criteria',
                hints: [
                    'Real diagnostic criteria show individual variation and probabilistic language',
                    'Overly deterministic or mathematical presentations suggest fabrication'
                ],
                pairs: [
                    {
                        condition: 'Guillain-Barré Syndrome',
                        real: 'Acute autoimmune polyneuropathy causing ascending paralysis following infection. Weakness begins in legs and rises. CSF shows albuminocytologic dissociation. Most patients recover with supportive care.',
                        fake: 'Autoimmune polyneuropathy with descending paralysis pattern starting at 3-5 days post-infection. Progression rate of exactly 1 spinal segment per 18 hours with 91% consistency. EMG shows synchronized demyelination velocity of 28 m/s across all affected nerves.',
                        correctIsReal: true
                    }
                ],
                explain: 'GBS shows ASCENDING paralysis, not descending. The fake definition reversed the direction and added impossible precision: exact timing (1 segment/18 hrs), specific percentages (91%), and uniform nerve conduction velocity (28 m/s). Real neurological progression is variable, not clock-work.'
            },
            {
                title: 'Round 3: Molecular Mechanisms',
                hints: [
                    'Evaluate whether genetic/enzymatic cascades follow known biochemical pathways',
                    'Overly neat symptom-genotype correlations may indicate AI fabrication'
                ],
                pairs: [
                    {
                        condition: 'Porphyria Cutanea Tarda',
                        real: 'Most common porphyria. Uroporphyrinogen decarboxylase deficiency causes photosensitive skin blistering. Triggers include alcohol, estrogen, hepatitis C. Skin fragility and hyperpigmentation develop. Treated by phlebotomy or antimalarials.',
                        fake: 'Porphyrin accumulation disorder with phase-dependent enzyme inhibition. UROD activity decreases by exactly 12% per decade starting at age 30. Symptom severity correlates with serum iron at 0.87 coefficient. Treatment requires maintaining ferritin between 180-220 ng/mL for optimal enzyme recovery.',
                        correctIsReal: true
                    }
                ],
                explain: 'PCT involves enzyme DEFICIENCY, not decade-based progressive inhibition. The fake definition invented mathematical decline (12% per decade), spurious correlation coefficient (0.87), and overly precise treatment targets (180-220 ng/mL). Real enzyme disorders don\'t follow linear age-based mathematical progressions.'
            },
            {
                title: 'Round 4: Neurological Syndromes',
                hints: [
                    'Scrutinize whether neural pathway descriptions match neuroanatomy',
                    'Perfect bilateral symmetry or timing in brain lesions is physiologically implausible'
                ],
                pairs: [
                    {
                        condition: 'Wernicke-Korsakoff Syndrome',
                        real: 'Thiamine deficiency causing Wernicke encephalopathy (confusion, ataxia, ophthalmoplegia) potentially progressing to Korsakoff syndrome (anterograde amnesia, confabulation). Mammillary body and thalamic damage. Common in chronic alcoholism.',
                        fake: 'Thiamine deficiency syndrome with bimodal cognitive impairment. Initial phase affects hippocampal CA1 neurons exclusively, causing isolated working memory deficits. After precisely 21 days, secondary phase involves bilateral mammillary body damage with 0.8cc volume loss per hemisphere. Confabulation emerges only when both structures show >70% neuronal loss.',
                        correctIsReal: true
                    }
                ],
                explain: 'WKS involves COMBINED pathology from onset, not a phased 21-day progression. The fake definition invented: sequential single-structure involvement, precise timing (21 days), exact volume loss (0.8cc bilateral), and a threshold percentage (>70%) for symptom emergence. Real neurological damage patterns are simultaneous and variable, not mathematically staged.'
            }
        ];

        const gameData = {
            easy: { spot: easySpotRounds, call: easyCallRounds },
            medium: { spot: mediumSpotRounds, call: mediumCallRounds },
            hard: { spot: hardSpotRounds, call: hardCallRounds }
        };

        // GAME FUNCTIONS
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', state.darkMode);
            render();
        }

        function selectGameMode(mode) {
            state.gameMode = mode;
            state.screen = 'difficulty';
            render();
        }

        function selectDifficulty(diff) {
            state.difficulty = diff;
            state.screen = 'gameType';
            render();
        }

        function selectGameType(type) {
            state.gameType = type;
            state.screen = 'name';
            render();
        }

        function startGame() {
            const input = document.getElementById('playerNameInput');
            const name = input ? input.value.trim() : '';
            
            const validation = isNameValid(name);
            if (!validation.valid) {
                const errorEl = document.getElementById('nameError');
                if (errorEl) {
                    errorEl.textContent = validation.reason;
                }
                return;
            }
            
            state.playerName = name;
            state.screen = 'playing';
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            state.streak = 0;
            state.bestStreak = 0;
            state.lives = state.gameMode === 'survival' ? 3 : 0;
            state.startTime = state.gameMode === 'speedrun' ? Date.now() : null;
            
            if (state.gameMode === 'timed') {
                state.timer = 30;
                startTimer();
            }
            
            render();
        }

        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                state.timer--;
                render();
                
                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);
                    gameOver();
                }
            }, 1000);
        }

        function selectFact(idx) {
            if (state.revealed) return;
            state.selected = idx;
            render();
        }

        function submitAnswer() {
            if (state.selected === null) return;
            
            const rounds = gameData[state.difficulty][state.gameType];
            const round = rounds[state.round % rounds.length];
            
            let isCorrect = false;
            
            if (state.gameType === 'spot') {
                isCorrect = round.facts[state.selected].fake;
            } else {
                const positions = state.callMyBluffOrder === 0 
                    ? [round.pairs[0].real, round.pairs[0].fake]
                    : [round.pairs[0].fake, round.pairs[0].real];
                isCorrect = positions[state.selected] === round.pairs[0].real;
            }
            
            if (isCorrect) {
                state.score++;
                state.streak++;
                if (state.streak > state.bestStreak) {
                    state.bestStreak = state.streak;
                }
                triggerConfetti();
            } else {
                state.streak = 0;
                if (state.gameMode === 'survival') {
                    state.lives--;
                    if (state.lives <= 0) {
                        state.revealed = true;
                        setTimeout(() => gameOver(), 2000);
                        render();
                        return;
                    }
                }
            }
            
            state.revealed = true;
            render();
        }

        function nextRound() {
            state.round++;
            state.selected = null;
            state.revealed = false;
            state.callMyBluffOrder = null;
            
            const rounds = gameData[state.difficulty][state.gameType];
            const maxRounds = state.gameMode === 'classic' ? 4 : rounds.length;
            
            if (state.gameMode === 'classic' && state.round >= maxRounds) {
                gameOver();
            } else if (state.gameMode === 'speedrun' && state.round >= maxRounds) {
                gameOver();
            } else {
                render();
            }
        }

        function gameOver() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            
            if (state.gameMode === 'speedrun' && state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                state.finalTime = elapsed;
            }
            
            submitScore();
            state.screen = 'gameover';
            render();
        }

        function backToMenu() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            state.screen = 'menu';
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            state.streak = 0;
            state.callMyBluffOrder = null;
            render();
        }

        function triggerConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#FF9AA2', '#70D6FF', '#C49BFF', '#FFE380', '#4caf50', '#ff9800'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // LEADERBOARD
        function submitScore() {
            if (!state.playerName) return;
            
            const scoreData = {
                name: state.playerName,
                score: state.score,
                mode: state.gameMode,
                difficulty: state.difficulty,
                type: state.gameType,
                streak: state.bestStreak,
                timestamp: Date.now(),
                approved: false
            };
            
            if (state.gameMode === 'speedrun') {
                scoreData.time = state.finalTime;
            }
            
            db.ref('scores').push(scoreData);
        }

        function loadLeaderboard() {
            db.ref('scores').orderByChild('approved').equalTo(true).limitToLast(100).on('value', (snapshot) => {
                const scores = [];
                snapshot.forEach((child) => {
                    scores.push({ id: child.key, ...child.val() });
                });
                state.leaderboard = scores.reverse();
            });
        }

        function viewLeaderboard() {
            state.screen = 'leaderboard';
            render();
        }

        // RENDER
        function render() {
            const gameEl = document.getElementById('game');
            
            if (state.screen === 'menu') {
                renderMenu(gameEl);
            } else if (state.screen === 'difficulty') {
                renderDifficulty(gameEl);
            } else if (state.screen === 'gameType') {
                renderGameType(gameEl);
            } else if (state.screen === 'name') {
                renderName(gameEl);
            } else if (state.screen === 'playing') {
                renderGame(gameEl);
            } else if (state.screen === 'gameover') {
                renderGameOver(gameEl);
            } else if (state.screen === 'leaderboard') {
                renderLeaderboard(gameEl);
            }
        }

        function renderMenu(gameEl) {
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>Medical AI Detection Game</h1>
                        <p class="subtitle">Learn to spot AI-generated medical misinformation</p>
                    </div>
                    <div class="header-right">
                        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                            ${state.darkMode ? '☀️ Light' : '🌙 Dark'}
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Welcome! 🎮</h2>
                    <p style="margin-bottom: 20px; line-height: 1.6;">
                        AI can generate fake medical information that looks real. This game teaches you to spot the clues 
                        that reveal AI-generated content. Learn to detect false confidence, fake statistics, and impossible patterns!
                    </p>
                    
                    <h3 style="margin-bottom: 15px;">Choose Your Mode</h3>
                    <div class="mode-selection">
                        <div class="mode-card" onclick="selectGameMode('classic')">
                            <div class="mode-icon">🎯</div>
                            <div class="mode-title">Classic</div>
                            <div class="mode-desc">4 rounds, learn at your own pace</div>
                        </div>
                        <div class="mode-card" onclick="selectGameMode('timed')">
                            <div class="mode-icon">⏱️</div>
                            <div class="mode-title">Timed</div>
                            <div class="mode-desc">30 seconds to answer as many as you can</div>
                        </div>
                        <div class="mode-card" onclick="selectGameMode('survival')">
                            <div class="mode-icon">❤️</div>
                            <div class="mode-title">Survival</div>
                            <div class="mode-desc">3 lives - how long can you last?</div>
                        </div>
                        <div class="mode-card" onclick="selectGameMode('speedrun')">
                            <div class="mode-icon">⚡</div>
                            <div class="mode-title">Speedrun</div>
                            <div class="mode-desc">Complete all rounds as fast as possible</div>
                        </div>
                    </div>
                    
                    <button onclick="viewLeaderboard()" style="background: linear-gradient(135deg, #2196f3 0%, #4caf50 100%); margin-top: 20px;">
                        🏆 View Leaderboard
                    </button>
                </div>
            `;
        }

        function renderDifficulty(gameEl) {
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>Medical AI Detection Game</h1>
                        <p class="subtitle">${state.gameMode.charAt(0).toUpperCase() + state.gameMode.slice(1)} Mode</p>
                    </div>
                    <div class="header-right">
                        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                            ${state.darkMode ? '☀️ Light' : '🌙 Dark'}
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Choose Difficulty</h2>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Pick the right challenge level for your age and experience
                    </p>
                    
                    <div class="difficulty-grid">
                        <button class="difficulty-btn" onclick="selectDifficulty('easy')">
                            😊 Easy<br>
                            <span style="font-size: 11px; font-weight: normal;">Ages 7-10</span>
                        </button>
                        <button class="difficulty-btn" onclick="selectDifficulty('medium')">
                            🤔 Medium<br>
                            <span style="font-size: 11px; font-weight: normal;">Ages 13-16</span>
                        </button>
                        <button class="difficulty-btn" onclick="selectDifficulty('hard')">
                            🔥 Hard<br>
                            <span style="font-size: 11px; font-weight: normal;">University</span>
                        </button>
                    </div>
                    
                    <div class="difficulty-desc">
                        <strong>Easy:</strong> Simple clues, obvious AI tells, kid-friendly content<br>
                        <strong>Medium:</strong> Subtle patterns, requires critical thinking<br>
                        <strong>Hard:</strong> Complex medical concepts, sophisticated AI detection
                    </div>
                    
                    <button onclick="backToMenu()" style="background: #999; margin-top: 20px;">
                        ← Back to Menu
                    </button>
                </div>
            `;
        }

        function renderGameType(gameEl) {
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>Medical AI Detection Game</h1>
                        <p class="subtitle">${state.gameMode.charAt(0).toUpperCase() + state.gameMode.slice(1)} - ${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)}</p>
                    </div>
                    <div class="header-right">
                        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                            ${state.darkMode ? '☀️ Light' : '🌙 Dark'}
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Choose Game Type</h2>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Two ways to test your AI detection skills
                    </p>
                    
                    <div class="mode-selection">
                        <div class="mode-card" onclick="selectGameType('spot')">
                            <div class="mode-icon">🔍</div>
                            <div class="mode-title">Spot The Fake</div>
                            <div class="mode-desc">Find the AI-generated fake among 4 options</div>
                        </div>
                        <div class="mode-card" onclick="selectGameType('call')">
                            <div class="mode-icon">🎭</div>
                            <div class="mode-title">Call My Bluff</div>
                            <div class="mode-desc">Pick the correct definition from 2 choices</div>
                        </div>
                    </div>
                    
                    <button onclick="state.screen = 'difficulty'; render();" style="background: #999; margin-top: 20px;">
                        ← Back
                    </button>
                </div>
            `;
        }

        function renderName(gameEl) {
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>Medical AI Detection Game</h1>
                        <p class="subtitle">${state.gameMode.charAt(0).toUpperCase() + state.gameMode.slice(1)} - ${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} - ${state.gameType === 'spot' ? 'Spot The Fake' : 'Call My Bluff'}</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Enter Your Name</h2>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Your score will be saved to the leaderboard after approval
                    </p>
                    
                    <input 
                        type="text" 
                        id="playerNameInput" 
                        placeholder="Enter your name..." 
                        maxlength="30"
                        onkeypress="if(event.key === 'Enter') startGame()"
                    />
                    <div id="nameError" class="error-message"></div>
                    
                    <button onclick="startGame()" style="margin-top: 20px;">Start Game</button>
                    <button onclick="state.screen = 'gameType'; render();" style="background: #999; margin-top: 10px;">
                        ← Back
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                const input = document.getElementById('playerNameInput');
                if (input) input.focus();
            }, 100);
        }

        function renderGame(gameEl) {
            const rounds = gameData[state.difficulty][state.gameType];
            const round = rounds[state.round % rounds.length];
            const maxRounds = state.gameMode === 'classic' ? 4 : rounds.length;
            const displayRound = state.round % rounds.length;
            const progress = ((state.round + 1) / maxRounds) * 100;
            
            let headerExtras = '';
            if (state.gameMode === 'survival') {
                const livesHtml = Array(3).fill(0).map((_, i) => 
                    `<span class="life-icon ${i >= state.lives ? 'lost' : ''}">❤️</span>`
                ).join('');
                headerExtras += `<div class="lives-display">${livesHtml}</div>`;
            }
            
            if (state.gameMode === 'timed') {
                headerExtras += `<div class="timer-display ${state.timer <= 5 ? 'warning' : ''}">${state.timer}s</div>`;
            }
            
            if (state.streak > 0) {
                headerExtras += `<div class="streak-display">🔥 ${state.streak} Streak</div>`;
            }
            
            let hintsHtml = '';
            if (state.difficulty === 'easy' && round.hints && !state.revealed) {
                hintsHtml = `
                    <div class="hints-box">
                        <div class="hints-title">💡 Detection Tips:</div>
                        <ul class="hints-list">
                            ${round.hints.map(hint => `<li>${hint}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (state.difficulty === 'medium' && round.hints && !state.revealed) {
                hintsHtml = `
                    <div class="hints-box">
                        <div class="hints-title">💡 Look for:</div>
                        <ul class="hints-list">
                            ${round.hints.map(hint => `<li>${hint}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (state.difficulty === 'hard' && round.hints && !state.revealed) {
                hintsHtml = `
                    <div class="hints-box">
                        <div class="hints-title">🔬 Consider:</div>
                        <ul class="hints-list">
                            ${round.hints.map(hint => `<li>${hint}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let factsHtml = '';
            
            if (state.gameType === 'spot') {
                round.facts.forEach((fact, idx) => {
                    let classes = 'fact';
                    
                    if (state.revealed) {
                        if (fact.fake && state.selected === idx) classes += ' wrong';
                        else if (!fact.fake && state.selected === idx) classes += ' correct';
                        else if (fact.fake) classes += ' wrong';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && fact.fake) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ AI-GENERATED</span>' : '<span class="fact-badge badge-fake">AI FAKE</span>';
                    } else if (state.revealed && !fact.fake && state.selected === idx) {
                        badge = '<span class="fact-badge badge-real">✓ REAL</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    const letterClass = `letter-${letter.toLowerCase()}`;
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name">
                                <span class="fact-letter ${letterClass}">${letter}</span>
                                <span>${fact.name}</span>
                            </div>
                            <div class="fact-desc">${fact.desc}</div>
                            ${badge}
                        </div>
                    `;
                });
            } else {
                const pair = round.pairs[0];
                
                if (!state.revealed && state.callMyBluffOrder === null) {
                    state.callMyBluffOrder = Math.random() < 0.5 ? 0 : 1;
                }
                
                const positions = state.callMyBluffOrder === 0 ? [pair.real, pair.fake] : [pair.fake, pair.real];
                const correctIndex = positions[0] === pair.real ? 0 : 1;
                
                factsHtml = `
                    <div style="margin-bottom: 20px;">
                        <div style="background: rgba(76, 175, 80, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px; color: var(--border-primary);">${pair.condition}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">Which definition is correct?</div>
                        </div>
                    </div>
                `;
                
                positions.forEach((definition, idx) => {
                    const isCorrect = idx === correctIndex;
                    let classes = 'fact';
                    
                    if (state.revealed) {
                        if (isCorrect && state.selected === idx) classes += ' correct';
                        else if (!isCorrect && state.selected === idx) classes += ' wrong';
                        else if (isCorrect) classes += ' correct';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && !isCorrect) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ WRONG</span>' : '<span class="fact-badge badge-fake">FAKE</span>';
                    } else if (state.revealed && isCorrect) {
                        badge = '<span class="fact-badge badge-real">✓ CORRECT</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    const letterClass = `letter-${letter.toLowerCase()}`;
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name">
                                <span class="fact-letter ${letterClass}">${letter}</span>
                                <span>Definition ${letter}</span>
                            </div>
                            <div class="fact-desc">${definition}</div>
                            ${badge}
                        </div>
                    `;
                });
            }
            
            let explanation = '';
            if (state.revealed) {
                explanation = `
                    <div class="explanation show">
                        <div class="explanation-title">🧠 Why This Matters</div>
                        <div class="explanation-text">${round.explain}</div>
                    </div>
                `;
            }
            
            const roundCounter = state.gameMode === 'timed' ? '' : 
                state.gameMode === 'survival' ? `<span class="round-number">Round ${displayRound + 1}</span>` :
                `<span class="round-number">Round ${state.round + 1}/${maxRounds}</span>`;
            
            const submitButton = !state.revealed ? 
                `<button onclick="submitAnswer()" ${state.selected === null ? 'disabled' : ''}>Submit Answer</button>` : '';
            
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>${state.gameType === 'spot' ? 'Spot The Fake' : 'Call My Bluff'}</h1>
                        <p class="subtitle">${state.gameMode.charAt(0).toUpperCase() + state.gameMode.slice(1)} - ${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)}</p>
                    </div>
                    <div class="header-right">
                        ${headerExtras}
                        <div class="score">
                            <div class="score-label">Score</div>
                            <div class="score-value">${state.score}</div>
                        </div>
                    </div>
                </div>
                
                ${state.gameMode !== 'timed' ? `<div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${progress}%"></div>
                </div>` : ''}
                
                <div class="card">
                    <div class="round-info">
                        <div class="round-title">${round.title}</div>
                        ${roundCounter}
                    </div>
                    
                    ${hintsHtml}
                    
                    <div class="instructions">
                        ${state.gameType === 'spot' ? 
                            '🔍 <strong>3 are REAL. 1 is AI-generated.</strong> Which is the fake?' : 
                            '🎭 <strong>Pick the correct definition</strong> - one is real, one is AI-generated'
                        }
                    </div>
                    <div class="instructions" style="font-size: 12px; color: var(--text-muted);">
                        ⌨️ Keyboard shortcuts: A, B${state.gameType === 'spot' ? ', C, D' : ''} to select • Enter to continue
                    </div>
                    
                    <div class="facts">
                        ${factsHtml}
                    </div>
                    
                    ${submitButton}
                    ${explanation}
                    ${state.revealed ? '<button onclick="nextRound()" id="nextBtn" style="background: var(--enter-green); color: #333; margin-top: 10px;">Continue (Enter) →</button>' : ''}
                </div>
                <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Exit to Menu</button>
            `;
        }

        function renderGameOver(gameEl) {
            let message = '';
            
            if (state.gameMode === 'speedrun') {
                message = `Completed in ${state.finalTime} seconds!`;
            } else if (state.gameMode === 'survival') {
                message = `Survived ${state.round} rounds!`;
            } else if (state.gameMode === 'timed') {
                message = `Time's up!`;
            } else {
                message = state.score === 4 ? 'Perfect Score! 🎉' : state.score >= 3 ? 'Great Job! 🌟' : state.score >= 2 ? 'Good Effort! 👍' : 'Keep Practicing! 💪';
            }
            
            const submissionMessage = state.playerName 
                ? `<div class="message" style="color: var(--correct);">✓ Score submitted as "${state.playerName}"</div>
                   <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                       Your score will appear on the leaderboard after approval.
                   </p>`
                : '';
            
            const performanceText = state.score >= 3 ? 
                "You're great at detecting AI-generated content! Your skills will help you spot misinformation." :
                state.score >= 2 ?
                "You're learning the patterns! Keep practicing to improve your detection skills." :
                "AI detection takes practice. Try again and focus on the hints to improve!";
            
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>Game Over</h1>
                        <p class="subtitle">${state.gameMode.charAt(0).toUpperCase() + state.gameMode.slice(1)} Mode - ${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)}</p>
                    </div>
                </div>
                
                <div class="card game-over">
                    <h2>${message}</h2>
                    <div class="final-score">${state.score}</div>
                    <div class="message">Best Streak: ${state.bestStreak} 🔥</div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
                        ${performanceText}
                    </p>
                    ${submissionMessage}
                    
                    <button onclick="backToMenu()">Play Again</button>
                    <button onclick="viewLeaderboard()" style="background: linear-gradient(135deg, #2196f3 0%, #4caf50 100%); margin-top: 10px;">
                        🏆 View Leaderboard
                    </button>
                </div>
            `;
        }

        function renderLeaderboard(gameEl) {
            const modes = ['classic', 'timed', 'survival', 'speedrun'];
            const difficulties = ['easy', 'medium', 'hard'];
            
            let leaderboardHtml = '';
            
            modes.forEach(mode => {
                difficulties.forEach(diff => {
                    const filtered = state.leaderboard
                        .filter(s => s.mode === mode && s.difficulty === diff)
                        .slice(0, 10);
                    
                    if (filtered.length > 0) {
                        leaderboardHtml += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="margin-bottom: 15px; color: var(--border-primary);">
                                    ${mode.charAt(0).toUpperCase() + mode.slice(1)} - ${diff.charAt(0).toUpperCase() + diff.slice(1)}
                                </h3>
                                <div style="background: rgba(76, 175, 80, 0.05); border-radius: 8px; padding: 15px;">
                                    ${filtered.map((score, idx) => `
                                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                                            <span><strong>${idx + 1}.</strong> ${score.name}</span>
                                            <span style="color: var(--correct); font-weight: bold;">
                                                ${score.score} ${mode === 'speedrun' ? `(${score.time}s)` : ''}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
            });
            
            if (!leaderboardHtml) {
                leaderboardHtml = '<p style="text-align: center; color: var(--text-muted);">No scores yet. Be the first!</p>';
            }
            
            gameEl.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h1>🏆 Leaderboard</h1>
                        <p class="subtitle">Top AI Detection Experts</p>
                    </div>
                </div>
                
                <div class="card">
                    ${leaderboardHtml}
                    
                    <button onclick="backToMenu()" style="margin-top: 20px;">
                        ← Back to Menu
                    </button>
                </div>
            `;
        }

        // KEYBOARD SUPPORT
        document.addEventListener('keydown', (e) => {
            if (state.screen !== 'playing') return;
            
            const key = e.key.toUpperCase();
            
            if (key === 'ENTER') {
                if (state.revealed) {
                    nextRound();
                } else if (state.selected !== null) {
                    submitAnswer();
                }
            } else if (!state.revealed) {
                const maxOptions = state.gameType === 'call' ? 2 : 4;
                const idx = key.charCodeAt(0) - 65;
                if (idx >= 0 && idx < maxOptions) {
                    selectFact(idx);
                }
            }
        });

        // INITIALIZE
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        if (savedDarkMode) {
            state.darkMode = true;
            document.body.classList.add('dark-mode');
        }

        loadLeaderboard();
        render();
    </script>
</body>
</html>
