<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot The Fake</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e8f5e9 100%); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 32px; margin-bottom: 5px; }
        h2 { font-size: 24px; margin-bottom: 15px; }
        .subtitle { color: #666; font-size: 14px; }
        .score { text-align: right; }
        .score-label { font-size: 12px; color: #999; }
        .score-value { font-size: 36px; font-weight: bold; }
        .card { background: white; border: 2px solid #4caf50; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .round-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .round-title { font-size: 20px; font-weight: bold; }
        .round-number { background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
        .instructions { color: #666; margin-bottom: 20px; font-size: 14px; }
        .facts { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .fact { padding: 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: left; background: white; }
        .fact:hover:not(.disabled) { border-color: #4caf50; }
        .fact.selected { background: #e8f5e9; border-color: #4caf50; }
        .fact.correct { background: #e8f5e9; border-color: #4caf50; }
        .fact.wrong { background: #ffebee; border-color: #f44336; }
        .fact.disabled { cursor: not-allowed; }
        .fact-name { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #ff9800; }
        .fact-desc { font-size: 14px; color: #555; line-height: 1.5; }
        .fact-badge { display: inline-block; margin-top: 10px; padding: 6px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        .badge-fake { background: #f44336; }
        .badge-real { background: #4caf50; }
        .explanation { background: #f0f7e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none; }
        .explanation.show { display: block; }
        .explanation-title { font-weight: bold; margin-bottom: 8px; }
        .explanation-text { font-size: 14px; line-height: 1.6; color: #333; }
        button { background: linear-gradient(135deg, #ff9800 0%, #4caf50 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .game-over { text-align: center; }
        .final-score { font-size: 64px; font-weight: bold; color: #4caf50; margin: 20px 0; }
        .message { font-size: 18px; margin-bottom: 20px; }
        .lesson { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 13px; }
        .difficulty-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .difficulty-btn { padding: 12px; font-size: 14px; }
        .difficulty-btn.active { background: #4caf50; }
        .difficulty-btn.inactive { background: #ddd; color: #333; }
        .difficulty-btn:hover { transform: none; }
        .menu-section { margin-bottom: 30px; }
        .difficulty-desc { font-size: 12px; color: #666; margin-top: 10px; }
        .error-message { color: #f44336; font-size: 12px; margin-top: 5px; }
        input { font-family: inherit; }
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .score { margin-top: 15px; }
            h1 { font-size: 24px; }
            .difficulty-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div id="game"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUdAqlDwN_1lRlbBHaA37RPscAtuxIXTA",
            authDomain: "spot-fake-game.firebaseapp.com",
            databaseURL: "https://spot-fake-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spot-fake-game",
            storageBucket: "spot-fake-game.firebasestorage.app",
            messagingSenderId: "141455787893",
            appId: "1:141455787893:web:e94feb2716c98336f1753c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // NAME VALIDATION
        const blockedWords = [
            'f4g', 'fagg', 'n1gg', 'nigg', 'sh1t', 'shitt', 
            'kys', 'kill', 'die', 'slut', 'whore', 'cunt'
        ];

        const whitelistedNames = [
            'assana', 'assane', 'shaniqua', 'gaylord', 'dick', 'dickson', 
            'fanny', 'fannie', 'shitley', 'damn', 'dammit', 'ass'
        ];

        function isNameValid(name) {
            const lower = name.toLowerCase().trim();
            
            if (lower.length < 2 || lower.length > 30) {
                return { valid: false, reason: 'Name must be 2-30 characters' };
            }
            
            for (let word of blockedWords) {
                if (lower.includes(word)) {
                    return { valid: false, reason: 'Name contains restricted content' };
                }
            }
            
            const profanityPatterns = [
                { regex: /shit/i, safe: false },
                { regex: /fuck/i, safe: false },
                { regex: /damn/i, safe: false },
                { regex: /ass(?!ana|ane)/i, safe: false },
                { regex: /dick(?!inson|son)/i, safe: false },
                { regex: /dick$/i, safe: true },
                { regex: /fanny$/i, safe: true },
                { regex: /^hell/i, safe: false },
                { regex: /bitch/i, safe: false }
            ];
            
            for (let pattern of profanityPatterns) {
                if (pattern.regex.test(lower)) {
                    const isWhitelisted = whitelistedNames.some(wl => 
                        lower === wl.toLowerCase() || lower.includes(wl.toLowerCase())
                    );
                    if (!isWhitelisted && !pattern.safe) {
                        return { valid: false, reason: 'Name contains restricted content' };
                    }
                }
            }
            
            if (/(.)\1{4,}/.test(lower)) {
                return { valid: false, reason: 'Name contains too many repeated characters' };
            }
            
            if (!/[a-z]/i.test(lower)) {
                return { valid: false, reason: 'Name must contain at least one letter' };
            }
            
            return { valid: true };
        }

        let state = {
            gameStarted: false,
            mode: null,
            difficulty: 'medium',
            round: 0,
            score: 0,
            selected: null,
            revealed: false,
            complete: false,
            playerName: null,
            leaderboard: [],
            nameError: ''
        };

        // CALL MY BLUFF - EASY MODE
// CALL MY BLUFF - EASY MODE (fakes are obviously wrong, but same formatting as real)
const roundsEasy = [
    {
        title: "Round 1: Clear Definitions",
        pairs: [
            {
                condition: "Color Blindness",
                real: "An inability to perceive certain wavelengths of light, primarily in the red-green spectrum. Results from cone cell dysfunction in the retina. People typically see reduced color saturation in affected ranges.",
                fake: "An inability to process color information in the visual cortex, causing complete black and white vision identical to old photographs. Results from the visual cortex completely shutting down all color perception.",
                correctIsReal: true
            }
        ],
        explain: "The real version describes accurate cone dysfunction. The fake claims complete black-and-white vision (wrong) and vague 'visual cortex shutdown' mechanism."
    },
    {
        title: "Round 2: Sleep Issues",
        pairs: [
            {
                condition: "Insomnia",
                real: "A sleep disorder characterized by difficulty initiating or maintaining sleep, resulting in non-restorative sleep. Associated with daytime functional impairment and hyperarousal during sleep onset.",
                fake: "A condition where the brain completely loses the ability to sleep, resulting in permanent wakefulness where sleep becomes physically impossible forever.",
                correctIsReal: true
            }
        ],
        explain: "The real version describes actual sleep difficulty. The fake claims permanent inability to sleep ever (which would be fatal and doesn't exist)."
    },
    {
        title: "Round 3: Head and Pain",
        pairs: [
            {
                condition: "Migraine",
                real: "A primary headache disorder involving unilateral throbbing pain, typically lasting 4-72 hours, often accompanied by photophobia, phonophobia, and nausea. Involves trigeminovascular system activation.",
                fake: "A neurological condition where the brain physically shrinks and moves inside the skull, producing severe pain through direct mechanical tissue damage.",
                correctIsReal: true
            }
        ],
        explain: "The real version uses accurate terminology and mechanisms. The fake invents brain shrinkage and movement, which would cause permanent damage, not temporary headaches."
    },
    {
        title: "Round 4: Balance and Dizziness",
        pairs: [
            {
                condition: "Vertigo",
                real: "A vestibular symptom characterized by the illusion of rotational motion of self or environment. Results from dysfunction in the vestibular system, semicircular canals, or central vestibular pathways.",
                fake: "An extreme fear of heights causing the brain to reject all downward-looking signals, making it physically impossible to look down or climb.",
                correctIsReal: true
            }
        ],
        explain: "The real version describes vestibular dysfunction accurately. The fake describes phobia symptoms and invents false neural mechanisms that don't match vertigo."
    }
];

// CALL MY BLUFF - MEDIUM MODE (fakes have obvious wrong content + suspicious AI red flags)
const roundsMedium = [
    {
        title: "Round 1: Name Tricks",
        pairs: [
            {
                condition: "Cooley's Anemia",
                real: "A hereditary hemolytic anemia caused by mutations affecting beta-globin chain synthesis. Characterized by ineffective erythropoiesis and iron overload. Named after hematologist Thomas Benton Cooley who documented it in Mediterranean populations in 1925.",
                fake: "A metabolic disorder triggered by sustained extreme cold exposure, causing red blood cells to crystallize and rupture. Named after Dr. James Cooley's cryogenic research in Arctic expeditions during 1978.",
                correctIsReal: true
            }
        ],
        explain: "The real version is medically accurate: named after the physician Cooley, correct genetic basis. The fake misinterprets 'Cooley' as temperature and invents cryogenic cell crystallization mechanism."
    },
    {
        title: "Round 2: Misleading Names",
        pairs: [
            {
                condition: "Down Syndrome",
                real: "A chromosomal disorder resulting from triplication of chromosome 21 (trisomy 21), causing intellectual disability and characteristic phenotypic features. Named after John Langdon Hayden Down who documented it in 1866.",
                fake: "A mood regulation disorder where people experience uncontrolled downward emotional spirals and severe depression requiring permanent isolation to prevent harm.",
                correctIsReal: true
            }
        ],
        explain: "The real version is accurate: chromosomal basis, named after physician Down. The fake misinterprets the name as describing emotional state and invents false psychiatric symptoms."
    },
    {
        title: "Round 3: Medical Terms",
        pairs: [
            {
                condition: "Long Q-T Syndrome",
                real: "A cardiac arrhythmia disorder characterized by prolonged ventricular repolarization interval (QT interval >450ms males, >460ms females on ECG). Results from channelopathy affecting potassium or sodium channels. Risk for torsades de pointes.",
                fake: "A neurological disorder involving quantum mechanics dysfunction in synaptic structures, causing delayed signal propagation through axonal tubes. Produces severe temporal perception alterations and extreme slowness. Q-T stands for Quantum Tunneling.",
                correctIsReal: true
            }
        ],
        explain: "The real version is accurate: specific ECG measurements, ion channel basis, actual arrhythmia risk. The fake invents quantum biology mechanisms and nonsensical neurological symptoms."
    },
    {
        title: "Round 4: Doctor Names",
        pairs: [
            {
                condition: "Diamond-Blackfan Anemia",
                real: "A congenital erythroid hypoplasia caused by ribosomal protein mutations, leading to selective red blood cell precursor aplasia. Results in macrocytic anemia presenting in infancy. Named after hematologists Louis Diamond and Kenneth Blackfan in 1938.",
                fake: "An occupational poisoning from chronic exposure to diamond dust and blackfan minerals. Causes bone marrow fibrosis from cumulative mineral accumulation exceeding 500 micrograms in jewelers and miners.",
                correctIsReal: true
            }
        ],
        explain: "The real version is accurate: ribosomal protein mutations, selective erythroid aplasia, named after physicians. The fake misuses the physicians' names as if they were toxic minerals."
    }
];

// SPOT THE FAKE - EASY MODE (fakes are obviously absurd, matching format)
const spotFakeRoundsEasy = [
    {
        title: "Round 1: Body Basics",
        facts: [
            { name: "Sneezing", desc: "A reflexive expulsion of air from nasal passages in response to irritation. Mediated by trigeminal nerve stimulation triggering involuntary respiratory muscle contraction.", fake: false },
            { name: "Hiccups", desc: "Involuntary repetitive contractions of the diaphragm muscle triggered by phrenic nerve irritation. Produces characteristic breathing interruption with audible sound production.", fake: false },
            { name: "WiFi Hearing Syndrome", desc: "A condition where the inner ear develops sensitivity to 2.4 GHz radiofrequency waves, producing auditory perception of WiFi signals. Documented in 15% of modern populations.", fake: true },
            { name: "Yawning", desc: "A reflexive deep inhalation response modulated by the anterior cingulate cortex. Functions to increase cerebral blood flow and regulate core body temperature during fatigue.", fake: false }
        ],
        explain: "WiFi Hearing Syndrome is fake. Red flag: WiFi operates at radiofrequency wavelengths outside human auditory range. The 15% statistic lacks any research support."
    },
    {
        title: "Round 2: Eyes and Sight",
        facts: [
            { name: "Blinking", desc: "Rhythmic closing and opening of eyelids controlled by the facial nerve. Maintains corneal hydration and removes surface debris through tear distribution.", fake: false },
            { name: "Goosebumps", desc: "Contraction of arrector pili muscles innervated by sympathetic fibers. Produces temporary hair erection in response to cold or emotional stimuli. A vestigial response.", fake: false },
            { name: "Color-Sound Synesthesia", desc: "A cross-sensory condition where audio frequencies trigger instantaneous color changes in the tongue mucosa. Blue frequencies produce cyan pigmentation; high frequencies produce pink through anthocyanin secretion.", fake: true },
            { name: "Sweating", desc: "Thermoregulatory mechanism involving activation of eccrine sweat glands by sympathetic cholinergic innervation. Produces evaporative cooling through transepidermal water loss.", fake: false }
        ],
        explain: "Color-Sound Synesthesia is fake. Red flag: Tongues don't change pigmentation based on sound frequencies. The invented 'anthocyanin secretion' mechanism is nonsense."
    },
    {
        title: "Round 3: Digestive System",
        facts: [
            { name: "Coughing", desc: "A protective reflex involving rapid expulsion of air from the lungs to clear the airway. Mediated by the vagus nerve with involvement of respiratory muscles.", fake: false },
            { name: "Hunger", desc: "Physiological signal produced by ghrelin hormone secretion from gastric fundus cells when glucose levels decline. Perceived as abdominal sensations signaling caloric deficit.", fake: false },
            { name: "Reverse Digestion Syndrome", desc: "A condition where esophageal peristalsis becomes bidirectional, allowing partially digested food to travel backward through the stomach and ascend the esophagus over 4-6 hour periods.", fake: true },
            { name: "Tiredness", desc: "Central nervous system state produced by circadian rhythm signaling and accumulated sleep pressure via adenosine accumulation. Results in increased sleep propensity.", fake: false }
        ],
        explain: "Reverse Digestion Syndrome is fake. Red flag: The esophageal and stomach muscles create one-way flow through peristalsis. Reversing would require complete neurological reprogramming and doesn't happen."
    },
    {
        title: "Round 4: Emotions and Sleep",
        facts: [
            { name: "Crying", desc: "Emotional response involving tear production from lacrimal glands and respiratory changes mediated by hypothalamic-pituitary signaling. Serves social communication function.", fake: false },
            { name: "Dizziness", desc: "Sensation of spatial disorientation resulting from vestibular system dysfunction or central nervous system processing errors regarding body position. Can result from inner ear pathology.", fake: false },
            { name: "Memory Inversion Disorder", desc: "A neurocognitive condition where memories form normally but retrieve in completely reverse chronological order, producing accurate recall of events but in backwards temporal sequence.", fake: true },
            { name: "Sleepiness", desc: "Prodromal state preceding sleep onset characterized by reduced alertness and slowed reaction time. Mediated by melatonin signaling and circadian rhythm modulation.", fake: false }
        ],
        explain: "Memory Inversion Disorder is fake. Red flag: If memories retrieved backwards, you wouldn't recognize temporal causation or context. This describes amnesia, not inverted memory."
    }
];

// SPOT THE FAKE - MEDIUM MODE (fakes have specific AI red flags: made-up statistics, false mechanisms, unsourced claims)
const spotFakeRoundsMedium = [
    {
        title: "Round 1: Warming Up",
        facts: [
            { name: "Brain Freeze", desc: "Transient sharp headache produced by rapid cold stimulus contact with the palate. Involves trigeminal nerve stimulation followed by blood vessel vasodilation. Duration typically 30-60 seconds.", fake: false },
            { name: "Exploding Head Syndrome", desc: "A sensory phenomenon involving perception of sudden loud noise (explosion, crash sounds) without external acoustic source. Occurs at sleep-wake transitions. Completely benign with no neural damage.", fake: false },
            { name: "Sonic Perception Syndrome", desc: "A condition where electromagnetic frequency detection in the auditory cortex produces conscious sound perception of 50Hz electrical lines and 2.4GHz WiFi signals. Affects 2.3% of urban populations.", fake: true },
            { name: "Hiccups", desc: "Involuntary repetitive diaphragmatic contractions lasting seconds to minutes. Mediated by phrenic nerve irritation (C3-C5). An evolutionary remnant from amphibian respiratory mechanisms.", fake: false }
        ],
        explain: "Sonic Perception Syndrome is AI-generated. Red flags: suspiciously specific statistic (2.3%), unsourced prevalence claim, invented mechanism (humans don't hear radiofrequency)."
    },
    {
        title: "Round 2: Getting Tricky",
        facts: [
            { name: "Thunderclap Headache", desc: "Sudden-onset severe headache reaching peak intensity within 60 seconds. Characterized as 'worst headache of life' by patients. Can signal subarachnoid hemorrhage or cerebral vasoconstriction.", fake: false },
            { name: "Mirror Touch Synesthesia", desc: "A rare condition where observing tactile stimulation of others produces somatosensory activation in the observer's corresponding body region. Involves mirror neuron system hyperactivity.", fake: false },
            { name: "Chromatic Appetite Disorder", desc: "A neurocognitive dysfunction affecting food-selection pathways, preventing consumption of foods matching specific color wavelengths. Prevalence: 1 in 8,000. Managed through monochromatic diet or color-filtered spectacles.", fake: true },
            { name: "Foreign Accent Syndrome", desc: "A neurological condition where stroke or head injury alters motor speech control, producing speech patterns resembling foreign accents despite lacking linguistic knowledge. Documented in ~100 cases worldwide.", fake: false }
        ],
        explain: "Chromatic Appetite Disorder is fake. Red flags: invented condition with suspiciously precise prevalence (1 in 8,000), absurd mechanism (color perception blocking food intake), invented treatment (color-filtered glasses)."
    },
    {
        title: "Round 3: Expert Level",
        facts: [
            { name: "Cotard Delusion", desc: "A delusional belief that one is dead, does not exist, or has lost internal organs despite contradictory evidence. Often accompanied by nihilistic delusions regarding bodily functions.", fake: false },
            { name: "Numerical Dysmorphia", desc: "A condition where the parietal lobe's number circuits produce consistent +3 unit offset in quantity perception. First documented 1987. Approximately 600 verified cases globally.", fake: true },
            { name: "Alice in Wonderland Syndrome", desc: "Distortion of visual and somatosensory perception producing macropsia, micropsia, or metamorphopsia. Objects appear disproportionately sized; body parts feel resized. Often triggered by migraines or viral infections.", fake: false },
            { name: "Capgras Delusion", desc: "A delusional disorder where close relatives are believed replaced by identical impostors. Despite facial recognition, emotional disconnect produces conviction of replacement. Associated with right frontoparietal dysfunction.", fake: false }
        ],
        explain: "Numerical Dysmorphia is AI hallucination. Red flags: suspiciously specific pattern (always +3 units), arbitrary precision in statistics (600 cases), implausibly neat mathematical error from brain pathology."
    },
    {
        title: "Round 4: Can You Outsmart AI?",
        facts: [
            { name: "Takotsubo Cardiomyopathy", desc: "Acute reversible cardiac dysfunction from catecholamine surge during emotional stress. Produces left ventricular apical ballooning mimicking myocardial infarction on imaging. Named after Japanese octopus trap resemblance.", fake: false },
            { name: "Hemineglect", desc: "A neuropsychological syndrome from right hemisphere lesions producing contralateral spatial awareness deficit. Patients ignore left body side and left environmental field. Shows asymmetry in grooming and drawing.", fake: false },
            { name: "Prosopagnosia", desc: "An agnosia affecting face recognition despite intact visual acuity. Patients cannot recognize familiar faces including family or their own reflection. Must identify people by voice, gait, or clothing.", fake: false },
            { name: "Temporal Sequence Reversal Disorder", desc: "A temporal processing disorder where short-term memory traces organize in reverse chronological sequence for 15-30 second epochs. Associated with hippocampal-cerebellar timing circuit dysfunction.", fake: true }
        ],
        explain: "Temporal Sequence Reversal Disorder is fabricated. Red flags: suspiciously specific time window (15-30 seconds), technical-sounding but unsupported mechanism, memory doesn't store in reverse order."
    }
];

        function getRounds(difficulty, mode) {
            if (mode === 'spotfake') {
                if (difficulty === 'easy') return spotFakeRoundsEasy;
                if (difficulty === 'hard') return spotFakeRoundsHard;
                return spotFakeRoundsMedium;
            }
            if (difficulty === 'easy') return roundsEasy;
            if (difficulty === 'hard') return roundsHard;
            return roundsMedium;
        }

        function getNumOptions(mode) {
            return mode === 'spotfake' ? 4 : 2;
        }

        function setDifficulty(level) {
            state.difficulty = level;
            render();
        }

        function startGame(mode) {
            state.gameStarted = true;
            state.mode = mode;
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            render();
        }

        function backToMenu() {
            state.gameStarted = false;
            state.complete = false;
            state.playerName = null;
            state.round = 0;
            state.score = 0;
            state.selected = null;
            state.revealed = false;
            state.mode = null;
            state.nameError = '';
            render();
        }

        function selectFact(idx) {
            if (state.revealed) return;
            state.selected = idx;
            
            if (state.mode === 'spotfake') {
                const roundsToUse = getRounds(state.difficulty, state.mode);
                const round = roundsToUse[state.round];
                const isCorrect = round.facts[idx].fake;
                if (isCorrect) state.score++;
            } else {
                const roundsToUse = getRounds(state.difficulty, state.mode);
                const pair = roundsToUse[state.round].pairs[0];
                const isCorrect = (idx === 0) === pair.correctIsReal;
                if (isCorrect) state.score++;
            }
            
            state.revealed = true;
            render();
        }

        function nextRound() {
            const roundsToUse = getRounds(state.difficulty, state.mode);
            if (state.round < roundsToUse.length - 1) {
                state.round++;
                state.selected = null;
                state.revealed = false;
            } else {
                state.complete = true;
            }
            render();
        }

        function submitScore() {
            const nameInput = document.getElementById('playerNameInput');
            const name = nameInput.value.trim();
            
            const validation = isNameValid(name);
            
            if (!validation.valid) {
                state.nameError = validation.reason;
                render();
                return;
            }

            state.nameError = '';

            const timestamp = new Date().toISOString();
            const entry = {
                name: name,
                score: state.score,
                mode: state.mode,
                difficulty: state.difficulty,
                timestamp: timestamp
            };

            db.ref('scores').push(entry).then(() => {
                state.playerName = name;
                loadLeaderboard();
            }).catch(err => {
                console.error('Error submitting score:', err);
                state.nameError = 'Error saving score. Try again.';
                render();
            });
        }

        function loadLeaderboard() {
            db.ref('scores').orderByChild('score').limitToLast(100).once('value', (snapshot) => {
                const data = snapshot.val();
                state.leaderboard = [];
                if (data) {
                    Object.values(data).forEach(entry => {
                        state.leaderboard.push(entry);
                    });
                }
                state.leaderboard.sort((a, b) => b.score - a.score);
                render();
            });
        }

        document.addEventListener('keydown', (e) => {
    // If typing in an input field, only handle Enter for name submission
            if (document.activeElement.tagName === 'INPUT') {
                if (e.key === 'Enter') {
                    submitScore();
                }
                return;
            }
    
    // Game key controls only work during gameplay
            if (!state.gameStarted || state.complete) return;
    
            const key = e.key.toUpperCase();
            const numOptions = getNumOptions(state.mode);
    
            if (key === 'A') selectFact(0);
            else if (key === 'B') selectFact(1);
            else if (key === 'C' && numOptions >= 3) selectFact(2);
            else if (key === 'D' && numOptions >= 4) selectFact(3);
            else if (key === 'ENTER') {
                if (state.revealed && !state.complete) nextRound();
            }
        });
        
        function render() {
            const gameEl = document.getElementById('game');

            if (!state.gameStarted) {
                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Spot The Fake</h1>
                            <p class="subtitle">Can you tell real from misleading?</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="menu-section">
                            <h2>Select Game Mode</h2>
                            <button onclick="startGame('callmybluff')" style="margin-bottom: 10px;">Call My Bluff</button>
                            <p style="font-size: 12px; color: #666;">One real, one fake definition. Press A or B to choose.</p>
                            
                            <button onclick="startGame('spotfake')" style="margin-bottom: 10px; margin-top: 15px;">Spot The Fake</button>
                            <p style="font-size: 12px; color: #666;">Find the AI hallucination among 4 options. Press A, B, C, or D to choose.</p>
                        </div>

                        <div style="border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
                            <h2>Select Difficulty</h2>
                            <div class="difficulty-grid">
                                <button onclick="setDifficulty('easy')" class="difficulty-btn ${state.difficulty === 'easy' ? 'active' : 'inactive'}">Easy</button>
                                <button onclick="setDifficulty('medium')" class="difficulty-btn ${state.difficulty === 'medium' ? 'active' : 'inactive'}">Medium</button>
                                <button onclick="setDifficulty('hard')" class="difficulty-btn ${state.difficulty === 'hard' ? 'active' : 'inactive'}">Hard</button>
                            </div>
                            <p class="difficulty-desc">
                                ${state.difficulty === 'easy' ? 'Clear definitions, obvious fakes. Great for kids and beginners.' : 
                                  state.difficulty === 'medium' ? 'Tricky wording, plausible fakes. For intermediate players.' : 
                                  'Expert-level, deceptively realistic. For medical enthusiasts.'}
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.complete && !state.playerName) {
                gameEl.innerHTML = `
                    <div class="card game-over">
                        <h1>Game Complete!</h1>
                        <div class="final-score">${state.score} / 4</div>
                        <div class="message">
                            ${state.score === 4 ? "Perfect! You're a definition detective." : 
                              state.score === 3 ? "Excellent! You caught most of the tricks." :
                              state.score === 2 ? "Good effort! Misleading names are tough." :
                              "Keep practicing! These tricks are sneaky."}
                        </div>
                        <div style="margin: 20px 0;">
                            <input type="text" id="playerNameInput" placeholder="Enter your name" style="padding: 10px; width: 100%; border: 2px solid #4caf50; border-radius: 4px; font-size: 16px;">
                            ${state.nameError ? `<div class="error-message">${state.nameError}</div>` : ''}
                        </div>
                        <button onclick="submitScore()" style="margin-bottom: 10px;">Submit Score</button>
                        <button onclick="backToMenu()" style="background: #999; margin-bottom: 10px;">Back to Menu</button>
                        <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                    </div>
                `;
                return;
            }

            if (state.complete && state.playerName) {
                const rank = state.leaderboard.findIndex(e => e.name === state.playerName && e.score === state.score) + 1;
                let leaderboardHtml = '';
                state.leaderboard.slice(0, 10).forEach((entry, idx) => {
                    const isPlayer = entry.name === state.playerName && entry.score === state.score;
                    leaderboardHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: ${isPlayer ? '#fff9c4' : 'white'}; border-bottom: 1px solid #eee;">
                            <span>${idx + 1}. ${entry.name}</span>
                            <span style="font-weight: bold;">${entry.score}/4</span>
                        </div>
                    `;
                });

                gameEl.innerHTML = `
                    <div class="card game-over">
                        <h1>Game Complete!</h1>
                        <div class="final-score">${state.score} / 4</div>
                        <div class="message" style="font-size: 20px; color: #ff9800;">You ranked #${rank} on the leaderboard!</div>
                        <div style="background: #f5f5f5; border-radius: 8px; padding: 15px; margin: 20px 0;">
                            <div style="font-weight: bold; margin-bottom: 10px;">Top 10 Scores</div>
                            ${leaderboardHtml}
                        </div>
                        <button onclick="backToMenu()" style="margin-bottom: 10px;">Play Again</button>
                        <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                    </div>
                `;
                return;
            }

            const roundsToUse = getRounds(state.difficulty, state.mode);
            
            if (state.mode === 'spotfake') {
                const round = roundsToUse[state.round];
                let factsHtml = '';
                
                round.facts.forEach((fact, idx) => {
                    let classes = 'fact';
                    if (state.revealed) {
                        if (fact.fake && state.selected === idx) classes += ' correct';
                        else if (!fact.fake && state.selected === idx) classes += ' wrong';
                        else if (fact.fake) classes += ' wrong';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && fact.fake) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ AI-GENERATED FAKE</span>' : '<span class="fact-badge badge-fake">AI FAKE</span>';
                    } else if (state.revealed && !fact.fake && state.selected === idx) {
                        badge = '<span class="fact-badge badge-real">✓ REAL</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name"><span style="display: inline-block; min-width: 30px; font-weight: bold; color: #ff9800;">${letter}.</span> ${fact.name}</div>
                            <div class="fact-desc">${fact.desc}</div>
                            ${badge}
                        </div>
                    `;
                });

                let explanation = '';
                if (state.revealed) {
                    explanation = `
                        <div class="explanation show">
                            <div class="explanation-title">Why was it fake?</div>
                            <div class="explanation-text">${round.explain}</div>
                        </div>
                    `;
                }

                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Spot The Fake</h1>
                            <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                        </div>
                        <div class="score">
                            <div class="score-label">Score</div>
                            <div class="score-value">${state.score}/4</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="round-info">
                            <div class="round-title">${round.title}</div>
                            <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                        </div>
                        <div class="instructions">3 of these are REAL medical conditions. 1 is completely made up by AI. Which one is fake?</div>
                        <div class="instructions" style="font-size: 12px; color: #999;">Press A, B, C, or D on your keyboard to select</div>
                        <div class="facts">
                            ${factsHtml}
                        </div>
                        ${explanation}
                        ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
                    </div>
                    <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
                    <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                `;
            } else {
                const round = roundsToUse[state.round];
                const pair = round.pairs[0];
                
                let factsHtml = `
                    <div style="margin-bottom: 20px;">
                        <div style="background: #f0f7e8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #4caf50;">${pair.condition}</div>
                            <div style="font-size: 14px; color: #666;">Which definition is correct?</div>
                        </div>
                    </div>
                `;

                [pair.real, pair.fake].forEach((definition, idx) => {
                    const isCorrect = (idx === 0) === pair.correctIsReal;
                    let classes = 'fact';
                    
                    if (state.revealed) {
                        if (isCorrect && state.selected === idx) classes += ' correct';
                        else if (!isCorrect && state.selected === idx) classes += ' wrong';
                        else if (isCorrect) classes += ' wrong';
                        classes += ' disabled';
                    } else {
                        if (state.selected === idx) classes += ' selected';
                    }
                    
                    let badge = '';
                    if (state.revealed && !isCorrect) {
                        badge = state.selected === idx ? '<span class="fact-badge badge-fake">✗ WRONG</span>' : '<span class="fact-badge badge-fake">FAKE</span>';
                    } else if (state.revealed && isCorrect && state.selected === idx) {
                        badge = '<span class="fact-badge badge-real">✓ CORRECT</span>';
                    }
                    
                    const letter = String.fromCharCode(65 + idx);
                    factsHtml += `
                        <div class="${classes}" onclick="selectFact(${idx})">
                            <div class="fact-name">${letter}. ${idx === 0 ? 'Definition A' : 'Definition B'}</div>
                            <div class="fact-desc">${definition}</div>
                            ${badge}
                        </div>
                    `;
                });

                let explanation = '';
                if (state.revealed) {
                    explanation = `
                        <div class="explanation show">
                            <div class="explanation-title">Why?</div>
                            <div class="explanation-text">${round.explain}</div>
                        </div>
                    `;
                }

                gameEl.innerHTML = `
                    <div class="header">
                        <div>
                            <h1>Call My Bluff</h1>
                            <p class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</p>
                        </div>
                        <div class="score">
                            <div class="score-label">Score</div>
                            <div class="score-value">${state.score}/4</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="round-info">
                            <div class="round-title">${round.title}</div>
                            <span class="round-number">Round ${state.round + 1}/${roundsToUse.length}</span>
                        </div>
                        <div class="instructions">Pick the correct definition.</div>
                        <div class="instructions" style="font-size: 12px; color: #999;">Press A or B on your keyboard to select</div>
                        <div class="facts">
                            ${factsHtml}
                        </div>
                        ${explanation}
                        ${state.revealed ? `<button onclick="nextRound()" id="nextBtn">Press Enter or click to continue</button>` : ''}
                    </div>
                    <button onclick="backToMenu()" style="background: #999; margin-top: 10px;">Back to Menu</button>
                    <div class="lesson">Real medical names can be confusing. Always verify definitions with trusted medical sources.</div>
                `;
            }
        }

        loadLeaderboard();
        render();
    </script>
</body>
</html>
